# 2.Webpack

## ä¸€.webpackåˆæ¢

### 1.webpackæ˜¯ä»€ä¹ˆ

- è¦ä»ä¸€ç§å†™ä»£ç çš„æ€æƒ³è¯´èµ·ï¼Œå°±æ˜¯æŠŠä¸åŒçš„ä»£ç æ‹†åˆ†æˆä¸åŒçš„æ–‡ä»¶ï¼Œç„¶åè¿›è¡Œå¼•ç”¨ï¼Œè¿™æ ·åšå¾ˆå¥½ï¼Œä½†æ˜¯å¯¹äºwebä¼šæœ‰ä¸€ä¸ªé—®é¢˜
- é€šè¿‡å¼•ç”¨çš„æ–¹å¼ï¼Œå¦‚æœå¼•å…¥å…³ç³»å¾ˆå¤šçš„è¯ï¼Œå‰åé¡ºåºï¼Œä¾èµ–å…³ç³»ç­‰ç­‰ï¼Œéå¸¸çš„æ··ä¹±
- åæ¥å‡ºç°äº† CommonJS, CMD, AMD, ESM çš„å‡ºç°ï¼Œé€æ¸çš„è§£å†³äº†è¿™ä¸ªé—®é¢˜

```js
// ES Module å¯¼å‡º
export default {

}

// å¼•å…¥
import {} from ...
```

---

**åŸºæœ¬ä½¿ç”¨**

- å®‰è£…webpack: npm i webpack webpack-cli --save-dev
- npx webpack index.js å°±ä¼šè‡ªåŠ¨è¯†åˆ« import è¿™äº›ä¾èµ–ï¼Œç„¶åä¹Ÿä¼šè‡ªåŠ¨å‹ç¼©åˆ° dist/main.jsï¼ˆè¿™å°±æ˜¯webpackçš„è‡ªåŠ¨è®¾ç½®å½¢å¼ï¼‰
- â£ï¸ æ³¨æ„ï¼šnpx ä¼šæ‰¾ node_modules ä¸‹é¢çš„ï¼Œå°±ä¼šæ‰§è¡Œäº†ï¼Œ webpack-cli çš„ä½œç”¨æ˜¯ï¼Œèƒ½è®©æˆ‘ä»¬åœ¨å‘½ä»¤è¡Œä¸­è¿è¡Œ webpack

---

### 2.ä»€ä¹ˆæ˜¯æ¨¡å—æ‰“åŒ…å·¥å…·ï¼Ÿ

- ä½ å¯ä»¥ä¼šè®¤ä¸ºwebpackæ˜¯ä¸€ä¸ªJSçš„ç¿»è¯‘å™¨ï¼Œé”™äº†ï¼Œwebpackå…¶å®åªè®¤è¯† import ï¼Œè¿˜æ˜¯ä¸ºäº†å¯»æ±‚ä¾èµ–æ‰å…·æœ‰çš„è¿™ä¸ªåŠŸèƒ½ï¼ŒçœŸçš„JSç¿»è¯‘å™¨æ˜¯ babel
- webpack æ˜¯ä¸€ä¸ª æ¨¡å—æ‰“åŒ…å·¥å…·ï¼ˆä¹Ÿèƒ½è¯†åˆ« CommonJS, CMD, AMD è§„èŒƒçš„ä»£ç ï¼‰

---

### 3.ä½¿ç”¨webpackçš„é…ç½®æ–‡ä»¶ï¼ˆè¾“å…¥ && è¾“å‡º && modeï¼‰

- å®‰è£…å¥½äº†ä¹‹åï¼Œé»˜è®¤ npx webpack index.js å°±èƒ½è¿›è¡Œæ‰“åŒ…äº†ï¼ˆwebpack 4.x é»˜è®¤å€¼åŠŸèƒ½ï¼‰
- æ–°å»ºæ–‡ä»¶å¤¹ï¼šwebpack.config.js

```js
import path from 'path'

export default {

    // ç¯å¢ƒï¼ˆé»˜è®¤æ˜¯production || developmentæ˜¯å¼€å‘ç¯å¢ƒï¼Œä¸å‹ç¼©...ï¼‰
    mode: 'production',

    // å…¥å£
    entry: {
        main: 'å…¥å£æ–‡ä»¶'
    },

    // å‡ºå£
    output: {
        filename: 'è¾“å…¥æ–‡ä»¶å',
        path: path.resolve(__dirname, 'è¾“å…¥æ–‡ä»¶å¤¹')
    },

    // ......

}
```

---

## äºŒ.webpackçš„æ ¸å¿ƒæ¦‚å¿µ

### 1.ä»€ä¹ˆæ˜¯loader

- **å¦‚ä½•æ‰“åŒ…å›¾ç‰‡ï¼Ÿ**webpackåˆšå¼€å§‹å†™çš„æ—¶å€™ï¼Œæ˜¯åªæƒ³åšä¸€ä¸ªJSæ‰“åŒ…å·¥å…·ï¼Œåæ¥æ‰æœ‰çš„æ‰“åŒ…æ‰€æœ‰çš„åŠŸèƒ½ï¼Œè€Œé™¤äº†æ‰“åŒ…JSä¹‹å¤–çš„åŠŸèƒ½ï¼Œå…¶ä½™çš„åŠŸèƒ½éƒ½éœ€è¦æ¥è¿›è¡Œé…ç½®ï¼Œä¾‹å¦‚ æ‰“åŒ…å›¾ç‰‡ï¼Œå°±éœ€è¦åœ¨ module è¿›è¡Œé…ç½®
-  npm i file-loader -D

```js
const path = require('path');

module.exports = {

  // ç¯å¢ƒï¼ˆé»˜è®¤æ˜¯production || developmentæ˜¯å¼€å‘ç¯å¢ƒï¼Œä¸å‹ç¼©...ï¼‰
  mode: 'production',

  // å…¥å£
  entry: {
      main: 'å…¥å£æ–‡ä»¶'
  },

  // å‡ºå£
  output: {
      filename: 'è¾“å…¥æ–‡ä»¶å',
      path: path.resolve(__dirname, 'è¾“å…¥æ–‡ä»¶å¤¹')
  },

  // æ¨¡å—è§„åˆ™
  module: {
    rules: [
      {
        test: /\.jpg$/,
        use: {
          loader: 'file-loader'
        }
      }
    ]
  }

};
```

- **â£ï¸ æ€è€ƒï¼šfile-loader ä¼šæŠŠæ–‡ä»¶æ”¾åˆ°è¾“å‡ºæ–‡ä»¶å¤¹ä¸­ï¼Œç„¶åæ¢ä¸ªåå­—ï¼Œç„¶åè¿”å›åç§°**
- æˆ‘ä»¬åœ¨Vueä¸­ï¼Œä¼šæœ‰ .vue çš„æ–‡ä»¶ï¼Œè¿™æ—¶å€™å°±éœ€è¦ åœ¨ module ä¸­é…ç½® .vue çš„ loader å°±å¯ä»¥äº†


---

### 2.ä½¿ç”¨Loaderæ‰“åŒ…é™æ€èµ„æºï¼ˆå›¾ç‰‡ç¯‡ï¼‰

**file-loaderæ’ä»¶**

```js
module.exports = {
  // æ¨¡å—è§„åˆ™
  module: {
    rules: [
      {
        test: /\.(jpg|png|gif)$/,
        use: {
          loader: 'file-loader',
          options: {
            name: '[name].[ext]', // 
            outputPath: 'images/' // æ‰“åŒ…è¾“å‡ºæ–‡ä»¶å¤¹
          }
        }
      }
    ]
  }

}
```

---

**url-loader**

- å®‰è£…ï¼šnpm i url-loader --save-dev
- url-loader èƒ½å®ç°æ‰€æœ‰ file-loaderçš„åŠŸèƒ½ï¼Œé…ç½®ä¹Ÿä¸ç”¨å˜
- ä¸åŒçš„åœ°æ–¹åœ¨äºï¼Œurl-loader ä¼šæŠŠä½ çš„å›¾ç‰‡è½¬ä¸º base64 çš„å­—ç¬¦ä¸²ï¼ˆä½†æ˜¯è¿™æ ·å¦‚æœå›¾ç‰‡å¾ˆå¤§çš„è¯ï¼Œä¼šå¯¼è‡´é¡µé¢JSä¹Ÿå¾ˆå¤§ï¼‰
- æœ€ä½³çš„å®è·µæ˜¯ï¼Œå¦‚æœå›¾ç‰‡å°çš„è¯ï¼Œå°±ç”¨ url-loader æ‰“åŒ…ï¼Œå›¾ç‰‡å¾ˆå¤§çš„è¯ï¼Œå°±æ‰“åŒ…åˆ°æ–‡ä»¶å¤¹ä¸­

```js
module.exports = {
  // æ¨¡å—è§„åˆ™
  module: {
    rules: [
      {
        test: /\.(jpg|png|gif)$/,
        use: {
          loader: 'url-loader',
          options: {
            name: '[name].[ext]', // 
            outputPath: 'images/', // æ‰“åŒ…è¾“å‡ºæ–‡ä»¶å¤¹
            limit: 2048 // å¦‚æœå°äº 2kbï¼Œå°±ä¼šæ‰“åŒ…è¿›JSï¼Œå¦‚æœå¤§äºå°±æ‰“åŒ…åˆ°æ–‡ä»¶å¤¹ä¸­
          }
        }
      }
    ]
  }

}
```

---

### 3.ä½¿ç”¨loaderæ‰“åŒ…é™æ€èµ„æºï¼ˆæ ·å¼ç¯‡ï¼‰

- npm i css-loader style-loader --save-dev
- css-loaderï¼šä¼šåˆ†æå‡ ä¸ªCSSä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼Œæœ€åå¸®æˆ‘ä»¬æ‰“åŒ…æˆä¸€ä¸ªcssï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œcssé‡Œé¢å¯ä»¥åƒJSä¸€æ ·ï¼Œé€šè¿‡CSSè¿›è¡Œå¼•ç”¨äº†
- style-loaderï¼šæŠŠcss-loaderç”Ÿæˆçš„CSSå†…å®¹åŠ è½½åˆ° HTML é‡Œé¢çš„ header é‡Œé¢

```js
module.exports = {

  // ...

  module: {
    rules: [
      // ...
      {
        test: '/\.css$/',
        use: ['style-loader', 'css-loader']
      }
    ]
  }

}
```

---

**å¦‚æœç”¨å…¶ä»–çš„è¯­æ³•ï¼Œä¾‹å¦‚ scss**

- å®‰è£…ï¼šnpm i node-sass sass-loader --save-dev

```js
module.exports = {

  // ...

  module: {
    rules: [
      // ...
      {
        test: '/\.scss$/',
        use: ['style-loader', 'css-loader', 'sass-loader']
      }
    ]
  }

}
```

**â£ï¸ï¼šloader æ‰§è¡Œé¡ºåºæ˜¯ï¼Œä»ä¸Šåˆ°ä¸‹ï¼Œä»å³åˆ°å·¦çš„é¡ºåº**

---

**åŠ å…¥å‚å•†å‰ç¼€çš„loaderï¼špostcss-loader**

- npm i postcss-loader --save-dev
- éœ€è¦åˆ›å»ºä¸€ä¸ª postcss.config.js æ–‡ä»¶
- ä¸‹è½½è‡ªåŠ¨æ·»åŠ å‰ç¼€çš„æ’ä»¶ï¼šnpm i autoprefixer -save-dev

```js
// é»˜è®¤æ˜¯è¿™æ ·å†™çš„
module.exports = {
  parser: 'sugarss',
  plugins: {
    'postcss-import': {},
    'postcss-cssnext': {},
    'cssnano': {}
  }
}

// æˆ‘ä»¬ä¹Ÿå¯ä»¥è¿™ä¹ˆå†™
// è¿™ä¹ˆå†™çš„ä½œç”¨æ˜¯ï¼Œå½“æˆ‘ä»¬ä½¿ç”¨ postcss-loader çš„æ—¶å€™ï¼Œä¼šä½¿ç”¨ autoprefixer è¿™ä¸ªæ’ä»¶
module.exports = {
  plugins: [
    require('autoprefixer')
  ]
}
```

```js
module.exports = {

  // ...

  module: {
    rules: [
      // ...
      {
        test: '/\.scss$/',
        use: ['style-loader', 'css-loader', 'sass-loader', 'postcss-loader']
      }
    ]
  }

}
```

---

**æˆ‘ä»¬åœ¨ä¸Šé¢å¤„ç†é™æ€æ ·å¼æ–‡ä»¶ï¼Œå†™äº†å››ä¸ªloaderï¼Œå¦‚æœæˆ‘ä»¬æƒ³ç»™è¿™ä¸ªæ–‡ä»¶è¿›è¡Œé…ç½®å‘¢ï¼Ÿä¾‹å¦‚ç»™ css-loader è¿›è¡Œé…ç½®å‘¢ï¼Ÿ**


```js
module.exports = {

  // ...

  module: {
    rules: [
      // ...
      {
        test: '/\.scss$/',
        use: ['style-loader', {
          loader: 'css-loader',
          options: {
            importLoaders: 2 // è¿™ä¸ªè¡¨ç¤ºï¼Œæˆ‘ä»¬åœ¨cssä¸­å¼•å…¥çš„ æ–‡ä»¶ï¼Œä¸ç®¡æ˜¯ cssä¹Ÿå¥½è¿˜æ˜¯scssä¹Ÿå¥½ï¼Œéƒ½è¦å…ˆèµ°å‰é¢ä¸¤ä¸ªæ–‡ä»¶ï¼Œä¹Ÿå°±æ˜¯ postcss-loader, sass-loader
          }
        }, 'sass-loader', 'postcss-loader']
      }
    ]
  }

}
```

---

**cssæ¨¡å—ï¼ˆcssåªä½œç”¨äºä¸€ä¸ªæ¨¡å—ï¼Œç±»ä¼¼äºVueçš„ spoctï¼‰**


```js
module.exports = {

  // ...

  module: {
    rules: [
      // ...
      {
        test: '/\.scss$/',
        use: ['style-loader', {
          loader: 'css-loader',
          options: {
            importLoaders: 2,
            modules: true // å¼€å¯cssçš„æ¨¡å—åŒ–æ‰“åŒ…
          }
        }, 'sass-loader', 'postcss-loader']
      }
    ]
  }

}


// ä½¿ç”¨
import style from 'index.scss'

btn.style = style.red
```

---

**å¦‚ä½•æ‰“åŒ…å­—ä½“æ–‡ä»¶**

- ä¸»è¦ç”¨ file-loader è¿›è¡Œæ‰“åŒ…ï¼Œå°†å­—ä½“æ–‡ä»¶æ”¾åˆ°åˆé€‚çš„ç›®å½•ä¸‹


---

### 4.ä½¿ç”¨ plugins è®©æ‰“åŒ…æ›´ä¾¿æ·

**ä½¿ç”¨ç¬¬ä¸€ä¸ªæ’ä»¶ï¼šhtml-webpack-plugin**

- npm i html-webpack-plugin --save-dev
- åŠŸèƒ½ï¼šä¼šåœ¨æ‰“åŒ…å®Œæˆä¹‹åï¼Œè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªHTMLæ–‡ä»¶ï¼Œå¹¶æŠŠæ‰“åŒ…ä¹‹åçš„JSè‡ªåŠ¨å¼•å…¥åˆ°è¿™ä¸ªHTMLæ–‡ä»¶ä¸­

```js
// å…ˆå¼•å…¥ï¼Œå†å®ä¾‹åŒ–
const HtmlWebpackPlugin = require('html-webpack-plugin');

module.exports = {
  // å…ˆå¼€å‘æ¨¡å¼ï¼Œç­‰åšå®Œäº†å†ç”Ÿäº§æ¨¡å¼
  mode: 'development',
  
  entry: './src/vue.js',
  
  output: {
    path: path.resolve(__dirname, 'dist'),
    filename: 'vue.js'
  },

  // æ’ä»¶
  plugins: [
    new HtmlWebpackPlugin({
      // é…ç½®ï¼Œindex.html æ¨¡æ¿ï¼Œä»¥æ­¤ä¸ºæ¨¡æ¿è¿›è¡Œæ³¨å…¥
      template: './test/index.html'
    })
  ]

}

```

---

**ğŸ”¥ pluginè§£é‡Š**

- pluginå¯ä»¥åœ¨webpackè¿è¡Œåˆ°æŸä¸ªæ—¶åˆ»çš„æ—¶å€™ï¼Œå¸®ä½ åšä¸€äº›äº‹æƒ…ï¼ˆæœ‰ç‚¹åƒVueçš„ç”Ÿå‘½å‘¨æœŸå‡½æ•°ï¼‰
- ä¾‹å¦‚ï¼šhtml-webpack-plugin æ˜¯åœ¨æ‰“åŒ…ç»“æŸä¹‹åï¼Œå¸®æˆ‘ä»¬åšä¸€äº›äº‹æƒ…

---

**ä»‹ç»å¦ä¸€ä¸ªæ’ä»¶ï¼šclean-webpack-plugin**

- å®‰è£…ï¼šnpm i clean-webpack-plugin --save-dev

```js
const htmlWebpackPlugin = requiere('html-webpack-plugin ')
const cleanWebpackPlugin = require('clean-webpack-plugin')


module.exports = {
  // å…ˆå¼€å‘æ¨¡å¼ï¼Œç­‰åšå®Œäº†å†ç”Ÿäº§æ¨¡å¼
  mode: 'development',
  
  entry: './src/vue.js',
  
  output: {
    path: path.resolve(__dirname, 'dist'),
    filename: 'vue.js'
  },

  // æ’ä»¶
  plugins: [
    new htmlWebpackPlugin({
      // é…ç½®ï¼Œindex.html æ¨¡æ¿ï¼Œä»¥æ­¤ä¸ºæ¨¡æ¿è¿›è¡Œæ³¨å…¥
      template: 'src/index.html'
    }),
    new cleanWebpackPlugin(['dist'])
  ]

}

```

---

### 5.entry ä¸ output çš„åŸºæœ¬é…ç½®

```js

module.exports = {

  entry: {
    main: './src/index.js',
    main1: './src/index.js'
  },
  
  output: {
    filename: '[name].js',
    publicPath: 'https://cdn.com.cn', // é…ç½®å¼•å…¥å‰ç¼€
    path: path.resolve(__dirname, 'dist')
  },

  // ä¼šæ‰“åŒ…æˆ main.js, main1.jsï¼Œè¿˜æœ‰æ›´å¤šï¼Œå°±è¦æŸ¥é˜…å®˜æ–¹æ–‡æ¡£äº†

}


```

---

### 6.SourceMapé…ç½®

- ä¸ºä»€ä¹ˆè¦æœ‰è¿™ä¸ªä¸œè¥¿ï¼Œå› ä¸ºæˆ‘ä»¬æ‰“åŒ…ä¹‹åï¼Œæ‰€æœ‰çš„éƒ½åœ¨ä¸€ä¸ªJSä¸­ï¼Œå¦‚æœå‘ç”Ÿé”™è¯¯ï¼Œè°ƒè¯•çš„è¯ï¼Œæ²¡æœ‰åŠæ³•å‡†ç¡®å®šä½åˆ°æ˜¯å“ªé‡Œçš„é—®é¢˜
- SourceMap æ˜¯ä¸€ç§æ˜ å°„ï¼Œå®ƒçŸ¥é“æˆ‘ä»¬æ‰“åŒ…ä¹‹åçš„æ–‡ä»¶æ¯ä¸€è¡Œï¼Œæ˜¯æºæ–‡ä»¶ä¸­çš„å“ªä¸€è¡Œ
- è§£å†³äº†æˆ‘ä»¬æ‰“åŒ…ä¹‹åï¼Œè¿˜èƒ½æ­£ç¡®çš„æ‰¾åˆ°å…·ä½“ä»£ç 

```js

module.exports = {
  
  // å…ˆå¼€å‘æ¨¡å¼ï¼Œç­‰åšå®Œäº†å†ç”Ÿäº§æ¨¡å¼
  mode: 'development',
  
  // ä½¿ç”¨è¿™ä¸ªå°±å¯ä»¥äº†ï¼Œè¿™ä¸ªdevtool è¿˜æœ‰å¾ˆå¤šé…ç½®ï¼Œå…·ä½“æŸ¥é˜…æ–‡æ¡£
  devtool: 'cheap-module-eval-source-map',

  entry: './src/vue.js',
  
  output: {
    path: path.resolve(__dirname, 'dist'),
    filename: 'vue.js'
  },

  // ...
}
```

---

### 7.ä½¿ç”¨WebpackDevServeræé«˜å¼€å‘æ•ˆç‡

- æˆ‘ä»¬æ›´æ”¹äº†æ–‡ä»¶
- è§£å†³æ–¹æ³•ä¸€ï¼š webpack --watch
- è§£å†³æ–¹æ³•äºŒï¼šwebpackDevServer
- å®‰è£…ï¼šnpm i webpack-dev-server --save-dev

```js
module.exports = {
  
  // å¯åŠ¨ä¸€ä¸ªserve
  devServer: {
    contentBase: './dist',
    open: true
  }, 

  // ...
  
}
```

---

### 8.Hot Module Replacement çƒ­æ¨¡å—æ›´æ–°

- ä¸ºä»€ä¹ˆæœ‰è¿™ä¸ªåŠŸèƒ½å‘¢ï¼Ÿ
- å› ä¸ºå½“æˆ‘ä»¬å¯åŠ¨ webpackDevServe æˆ–è€… --watch ä¹‹åéƒ½ä¼šæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯ä¸€æ”¹å˜æ–‡ä»¶ï¼Œå°±ä¼šé‡æ–°åˆ·æ–°äº†ï¼Œæˆ‘ä»¬ä¹‹å‰çš„ä¸€ç³»åˆ—æ“ä½œéƒ½ä¸è¡Œ
- 

```js
const webpack = require('webpack')

module.exports = {
  // å¯åŠ¨ä¸€ä¸ªserve
  devServer: {
    contentBase: './dist',
    open: true,
    hot: true,
    hotOnly: true
  },

  plugins: [
    new webpack.HotModuleReplacementPlugn()
  ]

  // ...

}
```


---

### 9.ä½¿ç”¨babelå¤„ç†ES6è¯­æ³•

**é¦–é€‰æ–¹æ¡ˆä¸€ï¼šå»ºç«‹.babelrcæ–‡ä»¶å¤¹**

```js

```

---

**æ–¹æ¡ˆäºŒï¼šä½¿ç”¨webpackæ’ä»¶è¿›è¡Œé…ç½®**

- å®‰è£…ï¼šnpm i babel-loader @babel/core --save-dev
  - @babel/core
  - babel-loaderï¼šwebpack ä¸ babel åšé€šä¿¡çš„æ¡¥æ¢
- å®‰è£…ï¼šnpm i @babel/preset-env --save-devï¼ˆè¿™ä¸ªæ˜¯çœŸæ­£ES6è½¬ES5çš„æ‰€æœ‰è§„åˆ™ï¼‰

```js
// â£ï¸ æˆ‘ä»¬è¿™é‡Œåªèƒ½è½¬æ¢è¯­æ³•ï¼Œè¯´ç™½äº†åªèƒ½è½¬æ¢ ES6 ä¸­çš„è¯­æ³•ç³–ï¼Œè½¬ä¸äº† æµè§ˆå™¨å†…ç½®çš„ä¸€äº›ä¸œè¥¿ï¼Œä¾‹å¦‚ Promise ç­‰ç­‰ï¼Œè¿™å°±éœ€è¦ Polyfill
module.exports = {

  module: {
    rules: [
      {
        test: '/\.js$/',
        exclude: '/node_modules',
        loader: 'babel-loader',
        options: {
          presets: ['@babel/preset-env']
        }
      }
    ]
  },

  // ...
}
```

---

- å®‰è£…ï¼šnpm i @babel/polyfill --save

---

## ä¸‰.webpacké«˜çº§

### 1.Tree Shakingæ¦‚å¿µ

**æˆ‘å¼•å…¥ä»€ä¹ˆï¼Œå°±è®©webpackæ‰“åŒ…ä»€ä¹ˆï¼Œï¼ˆTree Shaking åªæ”¯æŒES Moduleï¼‰**

```js
module.exports = {

}
```

