# 3.å‰ç«¯æµ‹è¯•æ¡†æ¶Jest

::: warning
æ³¨æ„æ­¤å¤„ï¼šå†…å®¹ä¸å…¨ï¼Œç»“æ„æ··ä¹±ï¼Œç­‰å¾…é‡æ„...
:::

> ä¸€èˆ¬æƒ…å†µå†™å•å…ƒæµ‹è¯•çš„æ—¶é—´ï¼Œæ˜¯ä¸šåŠ¡æ—¶é—´çš„äºŒå€

---

## ç®€ä»‹

### ä¸ºä»€ä¹ˆè¦æœ‰æµ‹è¯•

- æ›´æ–°åŠŸèƒ½æ—¶ï¼Œä¸ä¼šç ´ååŸæœ‰é€»è¾‘
- è¿­ä»£æ—¶ï¼Œä¸æ–¹ä¾¿é˜…è¯»åˆ«äººçš„ä»£ç 

---

## â›„ï¸ç¬¬ä¸€éƒ¨åˆ†ï¼šJeståŸºç¡€

### 1.åœ¨æ²¡æœ‰æµ‹è¯•æ¡†æ¶çš„æ—¶ä»£ï¼Œæˆ‘ä»¬å†™ä¸€ä¸ªç®€å•çš„æµ‹è¯•

```js
// ä¹¦å†™ä¸€ä¸ªç®€å•çš„æµ‹è¯•æ–¹æ³•
function test (str, fn) {
    console.log(`%c+++ ${str} +++`, "color:blue")
    fn()
}

function expect (result) {
    return {
        toBe: function (lookRes) {
            if (result !== lookRes) {
                console.log(`%céªŒè¯ä¸é€šè¿‡ï¼šé¢„æœŸç»“æœæ˜¯ï¼š${lookRes}, çœŸå®ç»“æœæ˜¯ï¼š${result}`, "color:red")
            } else {
                console.log('%cæµ‹è¯•é€šè¿‡', "color:green")
            }
        }
    }
}


// éœ€è¦æµ‹è¯•çš„ä»£ç  
function add (a, b) {
    return a + b
}


// æµ‹è¯•ç”¨ä¾‹
test('æµ‹è¯•åŠ æ³•', () => {
    
    expect(add(1,2)).toBe(3)
    expect(add(1,2)).toBe(1)
    expect(add(1,)).toBe(1)
    expect(add(1,'')).toBe(1)
    expect(add()).toBe()

})

```

**æ•ˆæœå±•ç¤º**

<img src="https://itzkp-1253302184.cos.ap-beijing.myqcloud.com/notes/2.notes/8.4%E5%89%8D%E7%AB%AF%E4%BB%A3%E7%A0%81%E8%B4%A8%E9%87%8F/5.%E5%89%8D%E7%AB%AF%E6%B5%8B%E8%AF%95%E6%A1%86%E6%9E%B6Jest/1.%E6%B2%A1%E6%9C%89%E6%B5%8B%E8%AF%95%E6%A1%86%E6%9E%B6%E7%9A%84%E6%97%B6%E5%80%99%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E6%B5%8B%E8%AF%95.png" />

---

### 2.Jestçš„ç®€å•é…ç½®

**åŸºç¡€å®‰è£…ï¼Œè¿è¡Œ**

- å®‰è£…ï¼šnpm i jest -D
- ä½¿ç”¨çš„æ—¶å€™ï¼Œå¿…é¡»è¦ç”¨ æ¨¡å—åŒ–ï¼ˆå°±æ˜¯è¦å¯¼å‡ºï¼Œå¯¼å…¥ï¼Œå¯ä»¥ä½¿ç”¨ commn.js è§„èŒƒ æˆ–è€… es module æ ¼å¼ï¼‰
- Jestä¸»è¦åš é›†æˆæµ‹è¯•ï¼Œå’Œå•å…ƒæµ‹è¯•
- æˆ‘ä»¬ä½¿ç”¨æ¨¡å—åŒ–çš„è¯­æ³•ï¼Œæˆ‘ä»¬æµè§ˆå™¨æ­£å¸¸å°±æ— æ³•è®¿é—®äº†ï¼Œè¿™æ—¶å€™å°±éœ€è¦å’Œ webpack å°±è¡Œé…åˆäº†ï¼Œè¿™å°±æ˜¯ä¸€æ•´ä¸ªçš„å·¥ç¨‹æµ
- è¿è¡Œæµ‹è¯• npx test

---

**ç®€å•é…ç½®**

- npx jest --init åˆå§‹åŒ–é¡¹ç›®
- é…ç½®å®Œæˆä¹‹å ä¼šå¤šä¸€ä¸ª jest.config.js

```js
// For a detailed explanation regarding each configuration property, visit:
// https://jestjs.io/docs/en/configuration.html

module.exports = {
  // All imported modules in your tests should be mocked automatically
  // automock: false,

  // Stop running tests after `n` failures
  // bail: 0,

  // Respect "browser" field in package.json when resolving modules
  // browser: false,

  // The directory where Jest should store its cached dependency information
  // cacheDirectory: "/private/var/folders/4h/ykg022694sn1pw91fxq30xwc0000gn/T/jest_dx",

  // Automatically clear mock calls and instances between every test
  // clearMocks: false,

  // Indicates whether the coverage information should be collected while executing the test
  // collectCoverage: false,

  // An array of glob patterns indicating a set of files for which coverage information should be collected
  // collectCoverageFrom: null,

  // The directory where Jest should output its coverage files
  // coverageDirectory: null,

  // An array of regexp pattern strings used to skip coverage collection
  // coveragePathIgnorePatterns: [
  //   "/node_modules/"
  // ],

  // A list of reporter names that Jest uses when writing coverage reports
  // coverageReporters: [
  //   "json",
  //   "text",
  //   "lcov",
  //   "clover"
  // ],

  // An object that configures minimum threshold enforcement for coverage results
  // coverageThreshold: null,

  // A path to a custom dependency extractor
  // dependencyExtractor: null,

  // Make calling deprecated APIs throw helpful error messages
  // errorOnDeprecated: false,

  // Force coverage collection from ignored files using an array of glob patterns
  // forceCoverageMatch: [],

  // A path to a module which exports an async function that is triggered once before all test suites
  // globalSetup: null,

  // A path to a module which exports an async function that is triggered once after all test suites
  // globalTeardown: null,

  // A set of global variables that need to be available in all test environments
  // globals: {},

  // An array of directory names to be searched recursively up from the requiring module's location
  // moduleDirectories: [
  //   "node_modules"
  // ],

  // An array of file extensions your modules use
  // moduleFileExtensions: [
  //   "js",
  //   "json",
  //   "jsx",
  //   "ts",
  //   "tsx",
  //   "node"
  // ],

  // A map from regular expressions to module names that allow to stub out resources with a single module
  // moduleNameMapper: {},

  // An array of regexp pattern strings, matched against all module paths before considered 'visible' to the module loader
  // modulePathIgnorePatterns: [],

  // Activates notifications for test results
  // notify: false,

  // An enum that specifies notification mode. Requires { notify: true }
  // notifyMode: "failure-change",

  // A preset that is used as a base for Jest's configuration
  // preset: null,

  // Run tests from one or more projects
  // projects: null,

  // Use this configuration option to add custom reporters to Jest
  // reporters: undefined,

  // Automatically reset mock state between every test
  // resetMocks: false,

  // Reset the module registry before running each individual test
  // resetModules: false,

  // A path to a custom resolver
  // resolver: null,

  // Automatically restore mock state between every test
  // restoreMocks: false,

  // The root directory that Jest should scan for tests and modules within
  // rootDir: null,

  // A list of paths to directories that Jest should use to search for files in
  // roots: [
  //   "<rootDir>"
  // ],

  // Allows you to use a custom runner instead of Jest's default test runner
  // runner: "jest-runner",

  // The paths to modules that run some code to configure or set up the testing environment before each test
  // setupFiles: [],

  // A list of paths to modules that run some code to configure or set up the testing framework before each test
  // setupFilesAfterEnv: [],

  // A list of paths to snapshot serializer modules Jest should use for snapshot testing
  // snapshotSerializers: [],

  // The test environment that will be used for testing
  testEnvironment: "node",

  // Options that will be passed to the testEnvironment
  // testEnvironmentOptions: {},

  // Adds a location field to test results
  // testLocationInResults: false,

  // The glob patterns Jest uses to detect test files
  // testMatch: [
  //   "**/__tests__/**/*.[jt]s?(x)",
  //   "**/?(*.)+(spec|test).[tj]s?(x)"
  // ],

  // An array of regexp pattern strings that are matched against all test paths, matched tests are skipped
  // testPathIgnorePatterns: [
  //   "/node_modules/"
  // ],

  // The regexp pattern or array of patterns that Jest uses to detect test files
  // testRegex: [],

  // This option allows the use of a custom results processor
  // testResultsProcessor: null,

  // This option allows use of a custom test runner
  // testRunner: "jasmine2",

  // This option sets the URL for the jsdom environment. It is reflected in properties such as location.href
  // testURL: "http://localhost",

  // Setting this value to "fake" allows the use of fake timers for functions such as "setTimeout"
  // timers: "real",

  // A map from regular expressions to paths to transformers
  // transform: null,

  // An array of regexp pattern strings that are matched against all source file paths, matched files will skip transformation
  // transformIgnorePatterns: [
  //   "/node_modules/"
  // ],

  // An array of regexp pattern strings that are matched against all modules before the module loader will automatically return a mock for them
  // unmockedModulePathPatterns: undefined,

  // Indicates whether each individual test should be reported during the run
  // verbose: null,

  // An array of regexp patterns that are matched against all source file paths before re-running tests in watch mode
  // watchPathIgnorePatterns: [],

  // Whether to use watchman for file crawling
  // watchman: true,
};

```

---

**ä½¿ç”¨ ES Module æ–¹å¼è¿›è¡Œæµ‹è¯•**

- å®‰è£…ï¼šnpm i @babel/core @babel/preset-env -D
- æ–°å»ºæ–‡ä»¶å¤¹ï¼š.babelrc || babel.config.js

```js
// babel.config.js
module.exports = {
  presets: [
    [
      '@babel/preset-env',
      {
        targets: {
          node: 'current',
        },
      },
    ],
  ],
};
```

**â£ï¸ ä¸ºä»€ä¹ˆjest å¯ä»¥é€šè¿‡ä¸Šé¢çš„è®¾ç½®å°±èƒ½ä½¿ç”¨ ESM äº†ï¼Ÿä¸»è¦æ˜¯ Jestå†…ç½®äº† babel-jestï¼Œè¿è¡Œæµ‹è¯•ä¹‹å‰ï¼Œä¼šå…ˆè¯»å– .babelrc æˆ–è€… babel.config.js ï¼Œç„¶åå…ˆè½¬æ¢ï¼Œç„¶åå†æµ‹è¯•**

---

### 3.Jestä¸­çš„é€‚é…å™¨

- ä»€ä¹ˆæ˜¯é€‚é…å™¨ï¼Œå°±æ˜¯æˆ‘ä»¬æœŸå¾…ä»€ä¹ˆï¼Œå»åŒ¹é…ä»€ä¹ˆï¼Œæ”¾åˆ°è¯­æ³•ä¸Šå°±æ˜¯, toBe å°±æ˜¯ä¸€ä¸ª åŒ¹é…å™¨
- expect(add(1,2)).toBe(3)

```js

// ========== å’ŒçœŸå‡ç›¸å…³çš„åŒ¹é…å™¨ ===========

expect(1).toBe(1) // é€šè¿‡ï¼šæœ‰ç‚¹ç±»ä¼¼äº === 

expect({ name: 'æœ±æ˜†é¹' }).toEqual({ name: 'æœ±æ˜†é¹' }) // é€šè¿‡ï¼šåŒ¹é…å†…å®¹ç›¸ç­‰

expect(null).toBeNull() // é€šè¿‡ï¼šåŒ¹é…æ˜¯å¦æ˜¯ null

expect(undefined).toBeUndefined() // é€šè¿‡ï¼šåŒ¹é…æ˜¯å¦æ˜¯ undefined

expect(true).toBetruthy() // é€šè¿‡ï¼šåŒ¹é… æ˜¯å¦ä¸ºçœŸï¼Œå¡« 1 ä¹Ÿè¡Œ

expect(0).toBeFalsy() // é€šè¿‡ï¼šåŒ¹é…æ˜¯å¦ä¸ºå‡ï¼Œå¡« false ä¹Ÿè¡Œ

expect(0).not.toBeFalsy() // ä¸é€šè¿‡ï¼šå¯ä»¥é€šè¿‡ not è¿›è¡Œå–å

// ...


// ========== å’Œæ•°å­—ç›¸å…³çš„åŒ¹é…å™¨ ===========

expect(10).toBeGreaterThan(9) // é€šè¿‡ï¼ŒåŒ¹é…çš„æ˜¯ 10 æ˜¯å¦ æ¯” 9 å¤§

expect(10).toBeLessThan(11) // é€šè¿‡ï¼ŒåŒ¹é…çš„æ˜¯ 10 æ˜¯å¦ æ¯” 11 å°

expect(10).toBeGreaterThanOrEqual(10) // é€šè¿‡ï¼ŒåŒ¹é…çš„æ˜¯ 10 æ˜¯å¦ å¤§äºç­‰äº 10

expect(11).toBeLessThanOrEqual(11) // é€šè¿‡ï¼ŒåŒ¹é…çš„æ˜¯ 11 æ˜¯å¦å°äºç­‰äº 11

expect(0.1 + 0.2).toBeCloseTo(0.3) // é€šè¿‡ï¼Œåˆ¤æ–­å°æ•°æ˜¯å¦ç›¸åŒï¼Œç›´æ¥æ¯”è¾ƒçš„è¯ä¼šæœ‰ç²¾åº¦ç¼ºå¤±çš„é—®é¢˜ï¼Œæ¯”è¾ƒä¸äº†

// ...


// ========= å’Œå­—ç¬¦ä¸²ç›¸å…³çš„åŒ¹é…å™¨ ===========

expect('æœ±æ˜†é¹').toMatch('æ˜†é¹') // é€šè¿‡ï¼ŒåŒ¹é…çš„æ˜¯ 'æœ±æ˜†é¹' ä¸­æ˜¯å¦æœ‰ 'æ˜†é¹' å­—ç¬¦ | è¿˜å¯ä»¥å†™æ­£åˆ™è¡¨è¾¾å¼

// ...


// ========= å’Œæ•°ç»„ç›¸å…³çš„åŒ¹é…å™¨ ===========

expect([1,2,3]).toContain(2) // é€šè¿‡ï¼ŒåŒ¹é…çš„æ˜¯ æ•°ç»„ä¸­ æ˜¯å¦åŒ…å« 2 è¿™ä¸€é¡¹ï¼Œä¹Ÿå¯ä»¥åˆ¤æ–­ Set, Map è¿™ç§ç±»å‹çš„

// ...


// ========= å’Œå¼‚å¸¸ç›¸å…³çš„åŒ¹é…å™¨ ===========

expect(throw new Error('å‡ºç°é”™è¯¯')).toThrow() // é€šè¿‡ï¼ŒåŒ¹é…çš„æ˜¯ æ˜¯å¦å‡ºç°å¼‚å¸¸

// ...


```

---

## ğŸ’¦ç¬¬äºŒéƒ¨åˆ†ï¼šJestä¸­çš„æ—¥å¸¸ä½¿ç”¨

---

### 1.jewst --watchAll å‘½ä»¤è¡Œä»‹ç»

- w æŒ‰ä¸‹wé”®ï¼Œè°ƒå‡ºé¢æ¿
- f æŒ‰ä¸‹fé”®ï¼Œå°±ä¼šè·‘ä¸Šæ¬¡æ²¡æœ‰é€šè¿‡çš„æµ‹è¯•ï¼Œå†æ¬¡ç‚¹å‡»fé€€å‡ºè¿™ç§æ¨¡å¼
- o æŒ‰ä¸‹oé”®ï¼Œä¼šè·‘å’Œå½“å‰è¢«æ”¹å˜ç›¸å…³æ–‡ä»¶çš„æµ‹è¯•ï¼Œä¹Ÿå°±æ˜¯åªæµ‹è¯•ä¸€ä¸ªæ–‡ä»¶ï¼ˆè¿™ä¸ªéœ€è¦ä¾èµ–Gitï¼‰(jest --watch é»˜è®¤å°±æ˜¯è¿›å…¥oæ¨¡å¼) ğŸ”¥
- t æ ¹æ®ä¸€ä¸ªæ­£åˆ™è¡¨è¾¾å¼æ¥ç¡®å®šå“ªäº›æµ‹è¯•ç”¨ä¾‹è¢«æ‰§è¡Œ
- p ...
- ...

---

### 2.Jestä¸­å¯¹DOMèŠ‚ç‚¹æ“ä½œè¿›è¡Œæµ‹è¯•

- ä¾æ®ï¼šjest åœ¨ node ç¯å¢ƒä¸‹è‡ªå·±æ¨¡æ‹Ÿäº†ä¸€å¥— DOM çš„APIï¼ˆjsdomï¼‰
- å…¶ä½™çš„å’Œæµè§ˆå™¨æ“ä½œDOMåŸºæœ¬ä¸€è‡´

```js
// å…·æœ‰ documentï¼šdocument.body 
```

---

### 3.å¼‚æ­¥ä»£ç çš„æµ‹è¯•ï¼ˆdoneï¼‰

**ç¬¬ä¸€ç§æ–¹å¼ï¼šå›è°ƒ done**

```js
// asyncFn.js
export const asyncFn = (fn) => {

    setTimeout(() => {
        fn(100)
    }, 1000);

}

// 
// asyncFn.test.js
import { asyncFn } from './asyncFn.js'

// test suite
test('æµ‹è¯•å¼‚æ­¥ä»£ç  asyncFn', (done) => {
    asyncFn( (data) => {
        expect(data).toBe(100)
        done() // è¿™ä¸ªæ‰è¡¨ç¤ºæµ‹è¯•å®Œæˆ
    })
})

```

**â£ï¸ async/awaitè¯­æ³•ä¹Ÿå¯ä»¥åœ¨ Jestå¼‚æ­¥ä¸­ä½¿ç”¨**

---

### 4.Jestä¸­çš„é’©å­å‡½æ•°

```js

// åœ¨æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹ï¼Œæ‰§è¡Œä¹‹å‰è°ƒç”¨
beforeAll( () => {

})

// æ¯ä¸ªæµ‹è¯•ç”¨ä¾‹æ‰§è¡Œä¹‹å‰ï¼Œéƒ½ä¼šæ‰§è¡Œä¸€éè¿™ä¸ªå‡½æ•° 
beforeEach( () => {

})

// æ¯ä¸ªæµ‹è¯•ç”¨ä¾‹æ‰§è¡Œä¹‹åï¼Œéƒ½ä¼šæ‰§è¡Œä¸€éè¿™ä¸ªå‡½æ•°
afterEach( () => {

})

// æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹æ‰§è¡Œå®Œæˆä¹‹åï¼Œæ‰§è¡Œ 
afterAll( () => {

})


// ğŸ”¥ è¿™ä¸ªç›¸å½“äºåˆ†ç»„äº†ï¼Œtestæµ‹è¯•ç”¨ä¾‹
describe('æµ‹è¯•æŸæŸåŠŸèƒ½å—', () => {

  test('åŠŸèƒ½ç‚¹ä¸€', () => {

  })

  test('åŠŸèƒ½ç‚¹äºŒ', () => {
    
  })

  test('åŠŸèƒ½ç‚¹ä¸‰', () => {
    
  })
})

```


---

**é’©å­å‡½æ•°çš„ä½œç”¨åŸŸ**

- åœ¨æ¯ä¸€ä¸ª descirbe ä¸­éƒ½å¯ä»¥å†™ é’©å­å‡½æ•°ï¼Œå¯¹å…¶å†…éƒ¨çš„ test æœ‰æ•ˆ
- è€Œè¿™å°±æ˜¯ä¸€ä¸ªä½œç”¨åŸŸçš„æ¦‚å¿µ
- æ‹“å±•ï¼štest.only() å°±å¯ä»¥åªæ‰§è¡Œè¿™ä¸ªä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼Œè€Œç¦æ­¢æ‰§è¡Œå…¶ä»–çš„æµ‹è¯•ç”¨ä¾‹ï¼ˆæˆ‘æ„Ÿè§‰æµ‹è¯•çš„æ—¶å€™å¯èƒ½ ç”¨åˆ°ï¼‰

---

### 5.Jestä¸­çš„ Mockï¼ˆå¾ˆå¥½ï¼Œä½†æ˜¯è¿˜éœ€è¦å†å®é™…åº”ç”¨ä¸­ä½“ä¼šï¼‰

- ç—›ç‚¹ï¼šæˆ‘ä»¬æœ‰ä¸€ä¸ªå‡½æ•°ï¼Œä¼ é€’ä¸€ä¸ªå‡½æ•°ä½œä¸ºå‚æ•°ï¼Œå¹¶ä¸”ä¼šæ‰§è¡Œï¼Œæˆ‘ä»¬æ€ä¹ˆæµ‹è¯•ï¼Œè¿™ä¸ªå‡½æ•°ä¼ é€’çš„å‚æ•°ï¼Œè¢«æ‰§è¡Œäº†ï¼Ÿ

```js
// mockFn.js
export const mockFn = (fn) => {
    fn()
}

// mockFn.test.js
import { mockFn } from './math'

test('æµ‹è¯•å‡½æ•°æ˜¯å¦è¢«æ‰§è¡Œ', () => {

    let func = jest.fn(); // mock å‡½æ•°ï¼Œæ•è·å‡½æ•°çš„è°ƒç”¨
    mockFn(func)
    
    expect(func).toBeCalled() // æ˜¯å¦è¢«æ‰§è¡Œ
    
    console.log(func.mock) // æ‰€æœ‰çš„æ•°æ®,æ‰“å°æˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œæˆ‘ä»¬èƒ½åˆ¤æ–­çš„è¿˜æœ‰å¾ˆå¤š

    expect(func.mock.calls.length).toBe(1) // å‡½æ•°æ˜¯å¦è¢«è°ƒç”¨äº†ä¸€æ¬¡

    // è¿˜èƒ½è®¾ç½®å‚æ•°å’Œè¿”å›å€¼
    // è®¾ç½®å‚æ•°
    func.mockReturnVaue('è¿”å›å€¼') // è®¾ç½®è¿”å›å€¼

    // 
    func.mock.results // è¿”å›å€¼åˆ—è¡¨
})

```

---


## ç¬¬ä¸‰éƒ¨åˆ†ï¼š