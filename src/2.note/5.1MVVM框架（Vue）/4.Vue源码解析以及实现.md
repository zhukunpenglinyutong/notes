# 4.Vueæºç è§£æä»¥åŠå®ç°

> æ ¹æ®vueæºç ï¼Œå®ç°ä¸€ä¸ªç®€å•çš„vue

## æ­å»ºåŸºç¡€ç¯å¢ƒ

### å®‰è£… rollup

::: tip rollup ç®€ä»‹
è¿™ä¸ªåº“æ‰“åŒ…jsï¼Œæ‰“åŒ…å‡ºçš„ä»£ç æ›´åŠ ç®€æ´
:::

- rollupï¼šæ‰“åŒ…å·¥å…·
- rollup-plugin-babelï¼šrollup å’Œ babelåšä¸€ä¸ªå…³è”
- @babel/coreï¼šè¿™ä¸ªä¼šè°ƒç”¨ @babel/preset-env è½¬ä¹‰æˆ‘ä»¬çš„ä»£ç 
- @babel/preset-envï¼š
- rollup-plugin-serveï¼šå¯åŠ¨ä¸€ä¸ªæœ¬åœ°ç¯å¢ƒ

```sh
npm install rollup rollup-plugin-babel @babel/core @babel/preset-env rollup-plugin-serve -D
```

---

### é…ç½® rollup.confing.js å’Œ .babelrc

```js
import babel from 'rollup-plugin-babel'
import serve from 'rollup-plugin-serve'

export default {

  input: './src/index.js',

  output: {
    format: 'umd', // æ¨¡å—åŒ–çš„ç±»å‹ esmï¼Œcommonjs | umd amd
    name: 'Vue', // å…¨å±€å˜é‡çš„åå­—
    file: 'dist/umd/vue.js',
    sourcemap: true // å¯ä»¥è°ƒæ•´è½¬æ¢è½¬æ¢åçš„ä»£ç 
  },

  plugin: [
    babel({
      exclude: 'node_modules/**'
    }),
    serve({
      port: 3000,
      contentBase: '',
      openPage: './index.html'
    })
  ]

}
```

> .babelrc

```js
{
  "presets": [
    "@babel/preset-env"
  ]
}
```

---

### å¯åŠ¨

```json
"scripts": {
  "dev": "rollup -c -w"
},
```

> è®¿é—®ï¼šhttp://localhost:3000/


---


## vueåˆå§‹åŒ–æµç¨‹

::: tip å…¥å£å‡½æ•°
src/index.js
:::

```js
import { initMixin } from './init'

// æš‚æ—¶ä¸ç”¨ES6çš„Class,å› ä¸º classæœ‰æ•´ä½“æ€§ï¼Œå‡½æ•°éœ€è¦å†™åˆ°classé‡Œé¢ï¼Œä¸åˆ©äºæ‹†åˆ†
function Vue(options) {
  this._init(options) // å…¥å£æ–¹æ³•ï¼Œåšåˆå§‹åŒ–æ“ä½œ
}

// ğŸ”¥ å†™æˆä¸€ä¸ªä¸ªæ’ä»¶ï¼Œè¿›è¡Œå¯¹åŸå‹çš„æ‹“å±•

initMixin(Vue) // ä¸“é—¨åšåˆå§‹åŒ–çš„æ–‡ä»¶

export default Vue
```

---

::: tip åˆå§‹åŒ–æ–‡ä»¶
src/init.js
:::

```js
import { initState } from "./state"

/**
 * åˆå§‹åŒ–æ“ä½œå‡½æ•°
 * @param {*} Vue æ„é€ å‡½æ•°
 */
export function initMixin(Vue) {

  Vue.prototype._init = function(options) {
    const vm = this // è¿™é‡Œçš„thisæŒ‡å‘ï¼Œå½“å‰newå‡ºæ¥çš„å®ä¾‹
    vm.$options = options
    
    // åˆå§‹åŒ–çŠ¶æ€ï¼ˆå°†æ•°æ®åšä¸€ä¸ªåˆå§‹åŒ–çš„åŠ«æŒï¼Œå½“æˆ‘æ”¹å˜æ•°æ®çš„æ—¶å€™æ›´æ–°è§†å›¾ï¼‰
    // æœ‰å¾ˆå¤šç±»å‹çš„çŠ¶æ€ï¼šdata props watch computed
    initState(vm) 
  }

}
```

---

::: tip åˆå§‹åŒ–çŠ¶æ€
src/state.js
:::

```js
import { observe } from "./observer/index";

export function initState(vm) {
  const opts = vm.$options;
  
  // å…ˆåˆå§‹åŒ–å±æ€§
  if (opts.props) initProps(vm)
  if (opts.methods) initMethods(vm)
  if (opts.data) initData(vm)
  if (opts.computed) initComputed(vm)
  if (opts.watch) initWatch(vm)
}

// åˆå§‹åŒ– Data
function initData(vm) {
  let data = vm.$options.data

  // ä¼ è¿‡æ¥å¯èƒ½æ˜¯å¯¹è±¡æˆ–è€…å‡½æ•°ï¼Œä½†æ˜¯æˆ‘ä»¬å°±æƒ³è¦å¯¹è±¡ï¼ˆä¸‹é¢çš„å†™æ³•å°±å¯ä»¥ï¼‰
  // data.call() ä¼šæ‰§è¡Œå‡½æ•°ï¼Œä½œç”¨åŸŸæ˜¯ vm
  data = typeof data == 'function' ? data.call(vm) : data; 

  // æ•°æ®åŠ«æŒæ–¹æ¡ˆ
  // å¯¹è±¡ï¼šObject.defineProperty
  // æ•°ç»„ï¼šå•ç‹¬å¤„ç†
  observe(data)
}

// åˆå§‹åŒ– Computed
function initComputed(vm) {}

// åˆå§‹åŒ– Watch
function initWatch(vm) {}

// åˆå§‹åŒ– Props
function initProps(vm) {}

// åˆå§‹åŒ– Methods
function initMethods(vm) {}
```
