# 1.Nodeé¡¹ç›®ä»¿çŸ¥ä¹API.md

::: warning
æ³¨æ„æ­¤å¤„ï¼šæ­¤å¤„å†…å®¹éœ€è¦é‡æ–°æ¢³ç†
:::

---

## ğŸ”¥åºç« 

**æœ¬é¡¹ç›®é‡‡ç”¨ Koa2 + mongoose ä½œä¸ºåŸºç¡€ï¼Œé‡‡ç”¨JWTåšé‰´æƒï¼ˆTokenï¼‰ï¼Œæ˜¯æˆ‘ç†Ÿæ‚‰Koa2 + MongoDBå¼€å‘çš„å…¥é—¨é¡¹ç›®**

- æ”¶è·ä¸€ï¼šæŠ½ç¦»å‡ºä¸€ä¸ª Koa + mongoose çš„MVCç®€å•é¡¹ç›® [é¡¹ç›®åœ°å€](https://github.com/zhukunpenglinyutong/Koa-api-template)
- æ”¶è·äºŒï¼šåŠ æ·±äº† RESTful API çš„è§„èŒƒè®¤çŸ¥ï¼Œè§ä¸‹é¢çš„ç¬”è®°

---

## ğŸŒ´ç¬¬ä¸€ç« ï¼šè®¤è¯†RESTful API

---

### 1.RESTæ˜¯ä»€ä¹ˆä»¥åŠå®ƒçš„6ä¸ªé™åˆ¶

- **ä»€ä¹ˆæ˜¯REST**ï¼šRESTæ˜¯ä¸€ç§æ¶æ„é£æ ¼ï¼Œç”¨æ¥åˆ›å»ºç½‘ç»œæœåŠ¡
- **ä¸ºä½•å«REST**ï¼šè‹±è¯­å…¨ç§°æ˜¯ Representational State Transfer
  - Representationalï¼šæ•°æ®è¡¨ç¤ºå½¢å¼ï¼Œå¯ä»¥ç”¨å¾ˆå¤šç§ï¼Œä¸€èˆ¬ç”¨JSON
  - Stateï¼šå½“å‰çŠ¶æ€æˆ–è€…æ•°æ®
  - Transferï¼šæ•°æ®ä¼ è¾“

**é€šè¿‡å­—é¢æ„æ€æ¥çœ‹æ˜¯ä¸å¥½ç†è§£çš„ï¼Œæˆ–è€…è¯´ä¸å…¨é¢çš„ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥é€šè¿‡RESTçš„å…­ä¸ªé™åˆ¶æ¥æ›´æ·±åˆ»çš„è®¤è¯†REST**

- å®¢æˆ·-æœåŠ¡å™¨ï¼ˆClent-Serverï¼‰ï¼ˆè¿™ä¸ªè§£é‡Šéå¸¸çš„å¥½ğŸ”¥ï¼‰
  - å…³æ³¨ç‚¹åˆ†ç¦»ï¼ˆæœåŠ¡ç«¯å…³æ³¨æ•°æ®å­˜å‚¨ï¼Œæå‡äº†ç®€å•æ€§ï¼›å‰ç«¯ä¸“æ³¨ç”¨æˆ·ç•Œé¢ï¼Œæé«˜äº†å¯ç§»æ¤æ€§ï¼‰
  - ç®€å•æ€§è§£é‡Šï¼šè¿‡å»æœåŠ¡ç«¯ç«¯è¿˜éœ€è¦æ¸²æŸ“é¡µé¢ï¼Œç°åœ¨åªéœ€è¦å†™å¥½æ•°æ®å­˜å‚¨å°±å¥½äº†
  - å¯ç§»æ¤æ€§è§£é‡Šï¼šè°ƒç”¨æ¥å£ï¼Œæ¸²æŸ“å¹³å°çš„èƒ½åŠ›ï¼Œå¾ˆå¤šå¹³å°éƒ½æ”¯æŒè¿™ç§æ“ä½œ
- æ— çŠ¶æ€ï¼ˆStatelessï¼‰
  - æ‰€æœ‰ç”¨æˆ·ä¼šè¯ä¿¡æ¯éƒ½ä¿å­˜åœ¨å®¢æˆ·ç«¯
  - æ¯æ¬¡å»è¯·æ±‚å¿…é¡»åŒ…æ‹¬æ‰€æœ‰ä¿¡æ¯ï¼Œä¸èƒ½ä¾èµ–ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼ˆä¾‹å¦‚å°è¯´ç¿»é¡µï¼Œä½ æƒ³è¯·æ±‚ä¸‹ä¸€é¡µï¼ŒæœåŠ¡å™¨ä¸çŸ¥é“ä¸‹ä¸€é¡µæ˜¯å•¥ï¼Œéœ€è¦ä½ ç¡®å®šçš„è¯·æ±‚ç¬¬å‡ é¡µæ‰è¡Œï¼‰
  - ğŸ”¥æ— çŠ¶æ€çš„å¥½å¤„ï¼šæœåŠ¡ç«¯ä¸ç”¨ä¿å­˜ä¼šè¯ä¿¡æ¯ï¼Œæå‡äº†ç®€å•æ€§ï¼Œå¯é æ€§ï¼Œå¯è§æ€§
- ç¼“å­˜ï¼ˆCacheï¼‰
  - æ‰€æœ‰æœåŠ¡ç«¯å“åº”éƒ½è¦æ ‡è®°å¯ç¼“å­˜æˆ–è€…ä¸å¯ç¼“å­˜
  - ç¼“å­˜çš„å¥½å¤„ï¼šå‡å°‘å‰åç«¯äº¤äº’ï¼Œæå‡äº†æ€§èƒ½
- ç»Ÿä¸€æ¥å£ï¼ˆUniform Interfaceï¼‰ğŸ”¥
  - æ¥å£è®¾è®¡å°½å¯èƒ½ç»Ÿä¸€é€šç”¨ï¼Œæå‡äº†ç®€å•æ€§ï¼Œå¯è§æ€§
  - æ¥å£ä¸å®ç°è§£è€¦ï¼Œä½¿å‰åç«¯å¯ä»¥ç‹¬ç«‹å¼€å‘è¿­ä»£ï¼ˆæ¥å£å®šå¥½ä¹‹åï¼Œå‰ç«¯å¯ä»¥è‡ªå·±mockæ•°æ®ï¼Œä¸ç”¨ç­‰åç«¯å¼€å‘å®Œæˆï¼‰
- åˆ†å±‚ç³»ç»Ÿï¼ˆLayered Systemï¼‰
  - æ¯å±‚åªçŸ¥é“ç›¸é‚»çš„ä¸€å±‚ï¼Œåé¢éšè—çš„å°±ä¸çŸ¥é“äº†
  - å®¢æˆ·ç«¯ä¸çŸ¥é“æ˜¯åœ¨å’Œä»£ç†è¿˜æ˜¯çœŸæ­£çš„æœåŠ¡å™¨é€šä¿¡
  - å…¶ä»–å±‚ï¼šå®‰å…¨å±‚ï¼Œè´Ÿè½½å‡è¡¡å±‚ï¼Œç¼“å­˜å±‚ç­‰ï¼ˆé˜¿é‡Œå·´å·´æœ‰ä¸ªæœºæ„ä¸“é—¨åšè¿™ç§å±‚çš„ï¼Œä¸ç”¨å…³ç³»ä¸šåŠ¡é€»è¾‘ï¼‰
- æŒ‰éœ€ä»£ç ï¼ˆCode-On-Demandå¯é€‰ï¼‰ï¼ˆä¸æ˜¯å¾ˆé‡è¦ï¼‰
  - å®¢æˆ·ç«¯å¯ä»¥ä¸‹è½½è¿è¡ŒæœåŠ¡ç«¯ä¼ è¿‡æ¥ä»£ç ï¼ˆä¾‹å¦‚JSï¼‰
  - å‡å°‘ä¸€äº›åŠŸèƒ½ï¼Œç®€åŒ–å®¢æˆ·ç«¯

---

### 2.ç»Ÿä¸€æ¥å£é™åˆ¶ï¼ˆæ¥å£éœ€è¦ç»Ÿä¸€æˆä»€ä¹ˆæ ·å­ï¼Ÿï¼‰

- èµ„æºçš„æ ‡è¯†
  - èµ„æºæ˜¯ä»»ä½•å¯ä»¥å‘½åçš„çš„äº‹ç‰©ï¼Œæ¯”å¦‚ç”¨æˆ·ï¼Œè¯„è®ºç­‰
  - æ¯ä¸ªèµ„æºé€šè¿‡URLè¢«ç»Ÿä¸€çš„æ ‡è¯†ï¼ˆä¾‹å¦‚ï¼šhttps://api.github.com/usersï¼‰
- é€šè¿‡è¡¨è¿°æ¥æ“ä½œèµ„æºï¼ˆè¿™ä¸ªæˆ‘æ‡‚ï¼Œæˆ‘å°±æ˜¯è¿™æ ·ç”¨çš„ï¼‰
  - å®¢æˆ·ç«¯ä¸èƒ½ç›´æ¥æ“ä½œï¼ˆæ¯”å¦‚SQLï¼‰æœåŠ¡ç«¯èµ„æº
  - å®¢æˆ·ç«¯åº”è¯¥é€šè¿‡è¡¨è¿°ï¼ˆæ¯”å¦‚JSONï¼‰æ¥æ“ä½œèµ„æº
- è‡ªæè¿°ä¿¡æ¯
  - æ¯ä¸ªæ¶ˆæ¯ï¼ˆè¯·æ±‚æˆ–è€…å“åº”ï¼‰å¿…é¡»è¸¢ç‹—è¶³å¤Ÿçš„ä¿¡æ¯è®©æ¥å—è€…ç†è§£
  - ä¾‹å¦‚ï¼šä½ å¯ä»¥éœ€è¦ä¼ åª’ä½“ç±»å‹ï¼ˆapplication/json,application/xmlï¼‰
  - ä¾‹å¦‚ï¼šä½ éœ€è¦è§„å®šè¯·æ±‚ç±»å‹ï¼šGET,POST,DELETE
  - ä¾‹å¦‚ï¼šå“åº”æ˜¯å¦è¢«ç¼“å­˜ï¼šCache-Control
- è¶…åª’ä½“ä½œä¸ºåº”ç”¨çŠ¶æ€å¼•æ“ï¼ˆæ²¡æ‡‚ï¼‰
  - ...

åè®°ï¼šGitHub api æœ‰ v3ï¼Œä¹Ÿå°±æ˜¯ REST API,è¿˜æœ‰ v4 GraphQL api å­¦å®Œv3å¯ä»¥çœ‹ä¸‹v4

---

### 3.RESTful APIç®€ä»‹

- å­—é¢è§£é‡Šæ˜¯ï¼šç¬¦åˆRESTæ¶æ„é£æ ¼çš„API
- RESTful API å…·ä½“é•¿ä»€ä¹ˆæ ·å­å‘¢ï¼Ÿ
  - åŸºæœ¬çš„URLï¼Œä¾‹å¦‚:https//api.github.com/users
  - æ ‡å‡†HTTPæ–¹æ³•ï¼Œä¾‹å¦‚ GET,POST,PUT,PATCH,DELETE
  - ä¼ è¾“çš„æ•°æ®åª’ä½“ç±»å‹ï¼Œå¦‚JSONï¼ŒXML
- ç°å®ä¸¾ä¾‹
  - GET /users | è·å–useråˆ—è¡¨
  - GET /users/12 | æŸ¥çœ‹æŸä¸ªå…·ä½“çš„user
  - POST /users | åˆ›å»ºä¸€ä¸ªuser
  - PUT /users/12 | æ›´æ–°userä¸º12çš„ç”¨æˆ·
  - DELETE /users/12 | åˆ é™¤userä¸º12çš„ç”¨æˆ·

---

### 4.RESTful APIè®¾è®¡æœ€ä½³å®è·µï¼ˆè§„èŒƒåŒ–ï¼Œå¯¹æˆ‘å¾ˆé‡è¦ï¼‰ğŸ”¥

- è¯·æ±‚è®¾è®¡è§„èŒƒ âœ…
  - URLè¦ä½¿ç”¨åè¯ï¼Œå°½é‡ç”¨å¤æ•°ï¼Œå¦‚ /users
  - URLä½¿ç”¨åµŒå¥—è¡¨ç¤ºå…³è”å…³ç³»ï¼Œå¦‚ /users/12/repos/5
  - ä½¿ç”¨æ­£ç¡®çš„HTTPæ–¹æ³•ï¼Œå¦‚ GET/POST/PUT/DELETE
  - ä¸ç¬¦åˆå¢åˆ æ”¹æŸ¥çš„æƒ…å†µä¸‹ï¼šPOST/...
- å“åº”è®¾è®¡è§„èŒƒ âœ…
  - æŸ¥è¯¢ï¼ˆæ¯ä¸€ä¸ªè¿”å›å€¼éƒ½æ˜¯å¯ä»¥è¢«æŸ¥è¯¢çš„ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬åŠ ä¸Šè¿”å›æ¡ä»¶ï¼Œå°±èƒ½ç­›é€‰æˆ‘ä»¬æƒ³è¦çš„ç»“æœï¼‰
  - åˆ†é¡µ
  - å­—æ®µè¿‡æ»¤ï¼ˆå®Œæ•´çš„å­—æ®µå‡å¦‚æœ‰åä¸ªï¼Œè¿™ä¸ªå¯ä»¥è§„å®šæˆ‘æƒ³è¦çš„å­—æ®µï¼‰
  - çŠ¶æ€ç 
  - é”™è¯¯å¤„ç†ï¼ˆå¦‚æœé”™äº†ï¼Œè¦è§„èŒƒåŒ–çš„è¿”å›é”™è¯¯ä¿¡æ¯ï¼‰
- å®‰å…¨ï¼ˆè¿™ä¸ªä¹Ÿæ˜¯æœ‰æ”¶è·çš„ï¼‰âœ…
  - ä½¿ç”¨HTTPSï¼ˆä½¿ç”¨HTTPå®¹æ˜“è¢«ç¯¡æ”¹ï¼ŒåŠ ä¸Šä¸€äº›å¹¿å‘Šä»€ä¹ˆçš„ï¼Œå¾ˆçƒ¦ï¼‰
  - é‰´æƒï¼ˆéœ€è¦ç™»å½•æ‰èƒ½è¯·æ±‚æŸäº›æ¥å£ï¼‰
  - é™æµï¼ˆé˜²æ­¢æŸäº›åäººåˆ»æ„å ç”¨æ¥å£ï¼‰
- å¼€å‘è€…ä¼˜åŒ–
  - æ–‡æ¡£
  - è¶…åª’ä½“

---

## ğŸŒ³ç¬¬äºŒç« ï¼šç”¨Koa è¯´ Hello World

### 1.Koaç®€ä»‹

- ä¸€å¥è¯ç®€ä»‹ï¼šåŸºäºNode.jsçš„ä¸‹ä¸€ä»£webæ¡†æ¶
  - åŸºäºNode.jsï¼šè¯´æ˜koaæ˜¯ä¸€ä¸ªNode.jsæ¨¡å—
  - ä¸‹ä¸€ä»£ï¼šèš•é£Ÿç¬¬ä¸€ä»£Expresså¸‚åœº
  - webæ¡†æ¶ï¼šä¸æ˜¯å‘½ä»¤è¡Œå·¥å…·ï¼Œä¸æ˜¯ç®—æ³•
- å®˜ç½‘è¯¦ç»†ä»‹ç»
  - ç”±Expersså¹•åäººåŸç­äººé©¬æ‰“é€ 
  - Webåº”ç”¨å’ŒAPIå¼€å‘é¢†åŸŸ
  - æ›´å°ï¼Œæ›´å¯Œæœ‰è¡¨ç°åŠ›ï¼Œæ›´å¥å£®
  - åˆ©ç”¨asyncå‡½æ•°ï¼Œä¸¢å¼ƒå›è°ƒå‡½æ•°
  - å¢å¼ºé”™è¯¯å¤„ç†ï¼štry catch
  - æ²¡æœ‰æ†ç»‘ä»»ä½•ä¸­é—´ä»¶
  - å¿«é€Ÿè€Œæ„‰å¿«çš„ç¼–å†™ç¨‹åºï¼ˆç”»çš„ä¸€ä¸ªå¤§é¥¼ï¼‰

<img src="https://itzkp-1253302184.cos.ap-beijing.myqcloud.com/notes/2.note/5.%E5%85%B6%E4%BB%96%E9%9B%B6%E6%95%A3%E7%AC%94%E8%AE%B0/%E6%85%95%E8%AF%BE%E7%BD%91%E8%AF%BE%E7%A8%8BRESTful%20API/1.png" />

---

### 2.å®‰è£…æ­å»ºç¬¬ä¸€ä¸ªKoaç¨‹åº

- åˆå§‹åŒ–ç›®å½•ï¼šnpm i koa --save
- ä½¿ç”¨ï¼šå»ºç«‹ app.jsï¼Œè®©koaè¿”å›ä¸€ä¸ª hello world

```js
const Koa = require('koa');
const app = new Koa();

//use() æ–¹æ³•é‡Œé¢å¯ä»¥ä¼ é€’å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°å°±æ˜¯æˆ‘ä»¬è¯´çš„ä¸­é—´ä»¶
app.use( ctx => {
  ctx.body = "Hello World";
});

app.listen(3000)
```

---

### 3.Koaä¸­é—´ä»¶ä¸æ´‹è‘±æ¨¡å‹

- async/await ç¤ºä¾‹ï¼ˆå½“ä¸€ä¸ªè¯·æ±‚ä¾èµ–ä¸Šä¸ªè¯·æ±‚å®Œæˆçš„æƒ…å†µä¸‹ï¼Œéœ€è¦ç”¨åµŒå¥—ï¼Œè¿™ä¸ªéå¸¸çš„ä¸ä¼˜é›…ï¼‰

```js
// è¿™ä¸ªå¯æ˜¯è§£å†³äº†æˆ‘ä¸èƒ½åœ¨ä»»ä½•åœ°æ–¹ç”¨ async çš„æ–¹æ³•
(async () => {
  const res1 = await fetch('...') // åµŒå¥—ä¸€
  const res2 = await fetch('...') // åµŒå¥—äºŒ
})
```

- **å­¦ä¹ ç¼–å†™Koaä¸­é—´ä»¶**

```js
const Koa = require('koa');
const app = new Koa();

//use() æ–¹æ³•é‡Œé¢å¯ä»¥ä¼ é€’å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°å°±æ˜¯æˆ‘ä»¬è¯´çš„ä¸­é—´ä»¶,è¿™æ˜¯ä¸€ä¸ªä¸­é—´ä»¶ï¼Œæ‰§è¡Œå¤šä¸ªä¸­é—´ä»¶ï¼Œå¿…é¡»è¦å†™ next å‚æ•° ğŸ”¥ğŸ”¥ğŸ”¥
app.use( async (ctx, next) => {
  await next();
  ctx.body = "Hello World";
});

app.use( ctx => {
  console.log('æˆ‘ä¹Ÿæ˜¯ä¸­é—´ä»¶ï¼Œæˆ‘è¦å…ˆæ‰§è¡Œ')
});

app.listen(3000)

```

**æ´‹è‘±æ¨¡å‹**

<img src="https://itzkp-1253302184.cos.ap-beijing.myqcloud.com/notes/2.note/5.%E5%85%B6%E4%BB%96%E9%9B%B6%E6%95%A3%E7%AC%94%E8%AE%B0/%E6%85%95%E8%AF%BE%E7%BD%91%E8%AF%BE%E7%A8%8BRESTful%20API/2.png" />

---

## ğŸ„ç¬¬ä¸‰ç« ï¼šKoa å’Œ RESTful API çš„æœ€ä½³å®è·µ

### 1.è·¯ç”±ç®€ä»‹

- è·¯ç”±å†³å®šäº†ä¸åŒçš„URLæ˜¯å¦‚ä½•è¢« ä¸åŒæ‰§è¡Œçš„
- åœ¨Koaä¸­ï¼Œè·¯ç”±çš„æœ¬è´¨æ˜¯ä¸€ä¸ªä¸­é—´ä»¶
- æ€è€ƒï¼Œå¦‚æœæ²¡æœ‰è·¯ç”±ä¼šæ€ä¹ˆæ ·ï¼Ÿè¯·æ±‚å’Œå“åº”éƒ½æ²¡æ³• å·®å¼‚åŒ–ï¼Œè¯·æ±‚å’Œè¿”å›çš„ç»“æœéƒ½ä¸€æ ·ï¼Œå°±è·Ÿä¸Šé¢æˆ‘ä»¬è¿”å›çš„ Hello Worldä¸€æ ·ï¼Œè¿™.....æ˜¯ä¸è¡Œçš„
- è·¯ç”±å­˜åœ¨çš„æ„ä¹‰ï¼šå¤„ç†ä¸åŒçš„URLï¼Œå¤„ç†ä¸åŒçš„httpè¯·æ±‚ï¼Œè§£æURLä¸Šçš„å‚æ•°

---

### 2.è‡ªå·±ç¼–å†™Koaè·¯ç”±ä¸­é—´ä»¶

- ç›®æ ‡å®ç°åŠŸèƒ½ï¼šå¤„ç†ä¸åŒçš„URLï¼Œå¤„ç†ä¸åŒçš„httpæ–¹æ³•ï¼Œè§£æURLä¸Šçš„å‚æ•°

```js
const Koa = require('koa');
const app = new Koa();

//use() æ–¹æ³•é‡Œé¢å¯ä»¥ä¼ é€’å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°å°±æ˜¯æˆ‘ä»¬è¯´çš„ä¸­é—´ä»¶,è¿™æ˜¯ä¸€ä¸ªä¸­é—´ä»¶ï¼Œæ‰§è¡Œå¤šä¸ªä¸­é—´ä»¶ï¼Œå¿…é¡»è¦å†™ next å‚æ•°
app.use( ctx => {
  // â‘  å¤„ç†ä¸åŒçš„URLï¼šctx.url è¡¨ç¤ºä¸Šä¸‹æ–‡çš„URLï¼Œctxè¡¨ç¤ºä¸Šä¸‹æ–‡
  // â‘¡ å¤„ç†ä¸åŒçš„httpæ–¹æ³•ï¼šctx.method
  // â‘¢ è§£æURLä¸Šçš„å‚æ•° 
  ctx.body = `è·¯å¾„ï¼š${ctx.url}ï¼Œè¯·æ±‚ç±»å‹ï¼š${ctx.method}, å‚æ•°ï¼š${getURLParameters(ctx.url)}`
  
});

// è·å–urlä¸­çš„å‚æ•°
function getURLParameters(url) {
  const params = url.match(/([^?=&]+)(=([^&]*))/g)
  return params?params.reduce(
    (a, v) => (a[v.slice(0, v.indexOf('='))] = v.slice(v.indexOf('=') + 1), a), {}
  ):[]
}

app.listen(3000)
```

---

### 3.ä½¿ç”¨Koa-routerå®ç°è·¯ç”±

- å®‰è£…ï¼šnpm i koa-router --save

**åŸºæœ¬ä½¿ç”¨**

```js
const Koa = require('koa');
const app = new Koa();
const Router = require('koa-router');
const router = new Router;

// æ³¨å†Œè·¯ç”±
router.get('/', ctx => {
  ctx.body = 'è¿™æ˜¯é¦–é¡µ'
})

// è§£æURLå‚æ•°
router.get('/user/:id', ctx => {
  ctx.body = `è¿™æ˜¯ç”¨æˆ·${ctx.params.id}`
})

// æ³¨å†Œrouterä¸­é—´ä»¶ï¼ˆè¦ç”¨routerä¸­çš„routes()æ–¹æ³•ï¼‰
app.use(router.routes())

app.listen(3000)
```

**è·¯ç”±å‰ç¼€å’Œå¤šä¸­é—´ä»¶ä½¿ç”¨ï¼ˆè¿™é‡Œä½¿ç”¨ä¸è§„èŒƒï¼Œæ•´ç†ä»¥åæ¯”è¾ƒè§„èŒƒçš„ç»“æ„ï¼‰**

---

### 4.HTTP options æ–¹æ³•çš„ç”¨ï¼ˆé¢ï¼Œå¯¹æˆ‘ç›®å‰æ²¡å¤ªå¤§ç”¨ï¼Œå°±æ˜¯å¢åŠ äº›çŸ¥è¯†å¹¿åº¦ï¼‰

- ğŸ”¥options æ˜¯HTTPè¯·æ±‚ç±»å‹ä¸­çš„ä¸€ç§ï¼ˆGET,POST......ï¼‰
- è¿™æ˜¯ä¸€é“å¸¸è€ƒé¢è¯•é¢˜ï¼Œè¿˜å¯ä»¥å¸®åŠ©ç†è§£ koa-router çš„ allowedMethods çš„ä½œç”¨
- **ğŸ”¥options ä½œç”¨**
  - æ£€æµ‹æœåŠ¡å™¨æ‰€æ”¯æŒçš„è¯·æ±‚æ–¹æ³•
  - CORSä¸­çš„é¢„è§è¯·æ±‚
- **allowedMethods ä½œç”¨**
  - å“åº” options æ–¹æ³•ï¼Œå‘Šè¯‰æ‰€æ”¯æŒçš„è¯·æ±‚æ–¹æ³•
  - ç›¸åº”çš„è¿”å› 405ï¼ˆä¸å…è®¸ï¼‰å’Œ 501ï¼ˆæ²¡å®ç°ï¼‰

---

### ğŸ”¥5.å¢åˆ æ”¹æŸ¥åº”è¯¥è¿”å›ä»€ä¹ˆå“åº”ï¼Ÿ

**è¿™é‡Œå¬è¯´æ˜¯æœ€ä½³å®è·µï¼Œä½†æ˜¯æˆ‘è§‚ç‚¹æ˜¯ï¼Œæˆ‘å†çœ‹çœ‹ï¼Œé€‰æ‹©é€‚åˆè‡ªå·±çš„**

```js
const Koa = require('koa');
const app = new Koa();
const Router = require('koa-router');
const router = new Router;

// å¢
router.post('/', ctx => {
  ctx.body = [{}] // è¿”å›æ–°å»ºçš„æ•°æ®
})

// åˆ 
router.delete('/user', ctx => {
  ctx.status = 204 // è¿”å›çŠ¶æ€ç  204ï¼Œè¡¨ç¤ºæ²¡æœ‰å†…å®¹ï¼Œä½†æ˜¯æˆåŠŸäº†
})

// æ”¹
router.put('/user', ctx => {
  ctx.body = [{}] // è¿”å›ä¿®æ”¹åçš„æ•°æ®
})

// æŸ¥
router.get('/user', ctx => {
  ctx.body = [{},{},{}] // è¿”å›æ•°æ®åˆ—è¡¨
})


// æ³¨å†Œrouterä¸­é—´ä»¶ï¼ˆè¦ç”¨routerä¸­çš„routes()æ–¹æ³•ï¼‰
app.use(router.routes())
app.listen(3000)
```

---

## ğŸŒµç¬¬å››ç« ï¼škoaæ¡†æ¶çš„æ§åˆ¶å™¨ä»¥åŠè®¾è®¡æ›´åˆç†çš„ç›®å½•ç»“æ„

### 1.æ§åˆ¶å™¨ç®€ä»‹

- ä»€ä¹ˆæ˜¯æ§åˆ¶å™¨ï¼Ÿæ‹¿åˆ°è·¯ç”±åˆ†é…çš„ä»»åŠ¡ï¼Œå¹¶æ‰§è¡Œ
- åœ¨Koaä¸­ï¼Œæ§åˆ¶å™¨æ˜¯ä¸€ä¸ªä¸­é—´èŠ‚
- ä¸ºä»€ä¹ˆè¦ç”¨æ§åˆ¶å™¨
  - è·å–httpè¯·æ±‚å‚æ•°
  - å¤„ç†ä¸šåŠ¡é€»è¾‘ï¼ˆè·å–æ•°æ®ï¼Œå¤„ç†æ•°æ®ï¼Œå­˜å‚¨æ•°æ®...ï¼‰
  - æ ¹æ®æƒ…å†µå‘é€httpå“åº”
- è·å–httpè¯·æ±‚å‚æ•°
  - ï¼ˆæŸ¥è¯¢å­—ç¬¦ä¸²ï¼‰Query Stringï¼Œä¾‹å¦‚ ?q=keyword
  - ï¼ˆè·¯ç”±å‚æ•°ï¼‰Router Paramsï¼Œå¦‚ /users/:id ï¼ˆè¿™ä¸ªä¸€èˆ¬æ˜¯å¿…é€‰çš„ï¼Œè€Œä¸”å¯èƒ½æœ‰å¤šä¸ªè·¯ç”±å‚æ•°ï¼Œæˆ‘ä»¬å…¬å¸ä¹Ÿå·®ä¸å¤šæ˜¯è¿™æ ·çš„ï¼‰
  - ğŸ”¥ï¼ˆè¯·æ±‚ä½“ï¼‰Bodyï¼Œå¦‚ { name: 'æœ±æ˜†é¹' }ï¼ˆä¸€èˆ¬ç”¨jsonï¼‰ï¼ˆFromä¹Ÿæ˜¯å¾ˆå¸¸ç”¨çš„è¯·æ±‚ä½“ï¼‰
  - ï¼ˆè¯·æ±‚å¤´ï¼‰Headerï¼Œå¦‚ Accept,Cookie

---

**ğŸ”¥ç¼–å†™æ§åˆ¶å™¨æœ€ä½³å®è·µ**

- æ¯ä¸ªèµ„æºçš„æ§åˆ¶å™¨æ”¾åˆ°ä¸åŒçš„æ–‡ä»¶å¤¹ä¸‹
- å°½é‡ä½¿ç”¨ç±»+ç±»æ–¹æ³•çš„å½¢å¼ç¼–å†™æ§åˆ¶å™¨ï¼ˆæˆ‘æ˜¯ä¸€ä¸ªæ¥å£å°±æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œä»–è¿™ä¸ªçš„æ€æƒ³æ˜¯ï¼Œå†™æˆä¸€ä¸ªç±»ï¼Œç„¶åæˆ‘çš„è¿™äº›æ¥å£éƒ½æ˜¯ç±»æ–¹æ³•ï¼Œè¿™æ ·è¿™äº›æ¥å£å¯ä»¥ä½¿ç”¨ç±»çš„å…¬å…±å†…å®¹ï¼‰
- ä¸¥è°¨çš„é”™è¯¯å¤„ç†

---

### 2.è·å–httpè¯·æ±‚å‚æ•°

- è¯·æ±‚å‚æ•°æœ‰ï¼šè·å– query,è·å– router paramsï¼Œè·å– body, è·å– header
- é€šè¿‡æ–­ç‚¹è°ƒè¯•ï¼Œæˆ‘å‘ç° ctx è¿™ä¸ªä¸Šä¸‹æ–‡ä¸ŠæŒ‚è½½çš„æ˜¯æˆ‘éœ€è¦å¥½å¥½çœ‹çœ‹çš„å„ç§ä¸œè¥¿ï¼Œhttpå‚æ•°éƒ½åœ¨è¿™é‡Œé¢å†™ç€å‘¢ï¼Œåå­—ä¹Ÿæ˜¯é€šä¿—æ˜“æ‡‚
- ğŸ”¥bodyè¿™æ˜¯ä¸ªè¯·æ±‚ä½“ï¼Œä½†æ˜¯ koaæ˜¯æ²¡æœ‰è§£æè¯·æ±‚ä½“çš„åŠŸèƒ½çš„ï¼ˆctxä¸Šæ²¡æœ‰è§£æbodyçš„å†…å®¹ï¼Œctx.body æ˜¯è®¾ç½®è¿”å›çš„ï¼Œå’Œè¿™ä¸ªæ²¡å…³ç³»ï¼‰ï¼Œéœ€è¦åŠ ä¸€ä¸ªä¸­é—´ä»¶
- å®‰è£…è§£æè¯·æ±‚ä½“ä¸­é—´ä»¶ï¼šnpm i koa-bodyparser --save

```js
const bodyparser = require('koa-bodyparser')
// ......
app.use(bodyparser())

// ğŸ”¥ä½¿ç”¨ï¼šctx.request.boay
```

---

### 3.å‘é€HTTPå“åº”

- å¦‚ä½•å‘é€statusï¼Œbodyï¼Œheader

```js
// ......
router.get('/user', ctx => {
  ctx.status = 200 // è®¾ç½® status
  ctx.body = '...' // è®¾ç½® body
  ctx.set('Allow', 'GET,POST') // è®¾ç½®å“åº”å¤´
})
```

---

### ğŸ”¥4.æ›´åˆç†çš„ç›®å½•ç»“æ„

- è·¯ç”±ï¼Œæ§åˆ¶å™¨éƒ½æ”¾åœ¨ä¸€ä¸ªç›®å½•é‡Œ

```js
// ğŸ‡¨ğŸ‡³ routes æ–‡ä»¶å¤¹ /users.jsæ–‡ä»¶
const Router = require('koa-router');
const router = new Router; // new Router({prefix:'user'}) è¿™æ ·å¯ä»¥è®¾ç½®è·¯ç”±å‰ç¼€ï¼Œä¹Ÿæ˜¯å®ç”¨çš„

// æŸ¥
router.get('/user', ctx => {
  ctx.body = [{},{},{}] // ä¸€èˆ¬è¿”å›æ•°æ®åˆ—è¡¨
})

module.exports = router // å¯¼å‡º


// ğŸ‡¨ğŸ‡³ å†™ä¸€ä¸ª routes/index.j ç”¨æ¥æ‰¹é‡æ³¨å†Œè·¯ç”±
const fs = require('fs')
module.exports = app => {
  fs.readdirSync(__dirname).forEach(file => {
    if (file === 'index.js') {return;}
    const route = require(`./${file}`)
    app.use(route.routes()).use(route.allowedMethods())
  })
}

// ğŸ‡¨ğŸ‡³ app.js ä¸­ä½¿ç”¨æ‰¹é‡æ³¨å†Œ
const routing = require('./app/routes')
routing(app)

// ğŸ‡¨ğŸ‡³ å»ºç«‹ controllers æ–‡ä»¶å¤¹ï¼Œåœ¨é‡Œé¢å»ºç«‹ users.js ğŸ”¥ğŸ”¥ğŸ”¥ï¼ˆè¿™ä¸ªå®šä¹‰ç±»å’Œä½¿ç”¨ç±»çš„æ–¹å¼ï¼Œæˆ‘å–œæ¬¢ï¼ŒGETåˆ°äº†ï¼Œç¡®å®æ¯”æˆ‘å†™çš„Expressæ­£è§„ï¼‰
class Users {
  // è·å–ç”¨æˆ·åˆ—è¡¨
  getUsers (ctx) {
    ctx.body = 'è·å–äº†ç”¨æˆ·åˆ—è¡¨'
  }
}
module.exports = new Users()

// ğŸ‡¨ğŸ‡³åœ¨è·¯ç”±ä¸­ä½¿ç”¨
const { getUsers } = require('../controller/users') // è¿™æ˜¯ES6è¯­æ³•ï¼Œæ›´ç®€å•
// è·å–æ‰€æœ‰åˆ—è¡¨
router.get('/users', getUsers)
module.exports = router // å¯¼å‡º
```

---

## ğŸŒ±ç¬¬äº”ç« ï¼šå¤šç§æ–¹æ¡ˆå®ç°é”™è¯¯å¤„ç†æœºåˆ¶

### 1.é”™è¯¯å¤„ç†ç®€ä»‹

- ä»€ä¹ˆæ˜¯é”™è¯¯å¤„ç†ï¼Ÿé”™è¯¯å¤„ç†æ˜¯ç¼–ç¨‹è¯­è¨€æˆ–è®¡ç®—æœºç¡¬ä»¶ä¸­çš„ä¸€ç§æœºåˆ¶ï¼Œç”¨äºå¤„ç†è½¯ä»¶æˆ–ä¿¡æ¯ç³»ç»Ÿä¸­å‡ºç°çš„å¼‚å¸¸çŠ¶å†µ
- å¼‚å¸¸çŠ¶å†µæœ‰å“ªäº›ï¼Ÿ
  - è¿è¡Œæ—¶é”™è¯¯ï¼šéƒ½è¿”å›500ï¼ˆä»£è¡¨æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ï¼‰
  - é€»è¾‘é”™è¯¯ï¼šæ‰¾ä¸å¤šï¼ˆ404ï¼‰ï¼Œå…ˆå†³æ¡ä»¶å¤±è´¥ï¼ˆ412ï¼‰ï¼Œæ— æ³•å¤„ç†çš„
- ä¸ºä»€ä¹ˆè¦ç”¨é”™è¯¯å¤„ç†ï¼Ÿ
  - é˜²æ­¢ç¨‹åºæŒ‚æ‰
  - å‘Šè¯‰ç”¨æˆ·é”™è¯¯ä¿¡æ¯

---

### 2.koaè‡ªå¸¦çš„é”™è¯¯å¤„ç†

- å¦‚æœè¯·æ±‚çš„æ¥å£ä¸å­˜åœ¨çš„è¯ï¼Œå°±ä¼šè¿”å› 404
- å¦‚æœæœåŠ¡å™¨å†…éƒ¨è¯­æ³•é”™è¯¯ï¼Œæˆ–è€…å…¶ä»–é”™è¯¯ï¼Œå°±ä¼šè¿”å› 500

```js
// æ‰‹åŠ¨æŠ›å‡º
ctx.throw(404, 'è¿”å›æŠ¥é”™æ–‡æœ¬ä¿¡æ¯')
```

**â£ï¸ä½†æ˜¯è¿™é‡Œè¿”å›çš„éƒ½æ˜¯æ–‡å­—ï¼Œæˆ‘ä»¬æƒ³è¿”å›JSONï¼Œè¿™æ ·æ‰æ ¼å¼ç»Ÿä¸€**

---

### 3.è‡ªå·±ç¼–å†™é”™è¯¯å¤„ç†ä¸­é—´ä»¶

- å†™åˆ°æ‰€æœ‰ä¸­é—´ä»¶çš„æœ€å‰é¢

```js
// åŸç†å°±æ˜¯æ•æ‰ä¸‹ä¸€ä¸ªä¸­é—´ä»¶çš„æŠ¥é”™ï¼Œç„¶åè¿”å›çŠ¶æ€ç å’Œå†…å®¹ï¼ˆJSONæ ¼å¼ï¼‰
app.use(async (ctx, next) => {
  try {
    await next()
  } catch (err) {
    ctx.status = err.status || err.statusCode
    ctx.body = {
      message: err.message
    }
  }
})
```

---

### 4.ä½¿ç”¨ koa-json-errorè¿›è¡Œé”™è¯¯å¤„ç†

- å®‰è£…ï¼šnpm i koa-json-error --save

```js
// app.js
const error = require('koa-json-error')
app.use(error())

// å †æ ˆä¿¡æ¯éƒ½è¿”å›äº†ï¼Œè¿™é‡Œå¯ä»¥é…ç½®
// {
//     "message": "Not Found",
//     "name": "NotFoundError",
//     "stack": "NotFoundError: Not Found\n    at Object.throw (/Users/zhukunpeng/Desktop/RESU ful API/node_modules/koa/lib/context.js:97:11)\n    at /Users/zhukunpeng/Desktop/RESU ful API/node_modules/koa-json-error/lib/middleware.js:52:58\n    at processTicksAndRejections (internal/process/task_queues.js:89:5)",
//     "status": 404
// }
```

**ğŸ”¥è®¾ç½®ç¯å¢ƒå˜é‡ï¼Œè®©æˆ‘ä»¬åœ¨å¼€å‘æ—¶å€™é”™è¯¯å¤„ç†è¿”å›å †æ ˆä¿¡æ¯ï¼Œç”Ÿäº§ç¯å¢ƒä¸è¿”å›ï¼ˆæœªå®Œæˆï¼‰**

- å®‰è£…ï¼šnpm i cross-env --save-dev

---

### 5.ä½¿ç”¨koa-parameterè¿›è¡Œå‚æ•°æ ¡éªŒ

- å®‰è£…ï¼šnpm i koa-parameter --save

```js
// app.js
// è¿™ä¸ªé€šå¸¸æ˜¯æ ¡éªŒè¯·æ±‚ä½“
const parameter = require('koa-parameter')
app.use(parameter(app)) // å‚æ•°æ ¡éªŒï¼ŒåŠ å…¥appçš„è¯ï¼Œå°±èƒ½åœ¨å…¨å±€ä½¿ç”¨äº†

// controller/users.js

// æ–°å»ºç”¨æˆ·
async createUser(ctx) {
  
  ctx.verifyParams({
    name: {type: 'string'}
  })
  const { name } = ctx.request.body
  const user = await new User(ctx.request.body).save()
  ctx.body = user
}

```

**å¦‚æœé”™äº†çš„è¯**

<img src="https://itzkp-1253302184.cos.ap-beijing.myqcloud.com/notes/2.note/5.%E5%85%B6%E4%BB%96%E9%9B%B6%E6%95%A3%E7%AC%94%E8%AE%B0/%E6%85%95%E8%AF%BE%E7%BD%91%E8%AF%BE%E7%A8%8BRESTful%20API/10.png" />

**è¿˜æœ‰æ›´å¤šçš„é™åˆ¶æ¡ä»¶ï¼Œä¾‹å¦‚å¿…é€‰ï¼Œä¾‹å¦‚ä»€ä¹ˆç±»å‹ï¼Œè¿™ä¸ªéƒ½å¯ä»¥æŸ¥é˜…**

---

## ğŸŒ¿ç¬¬å…­ç« ï¼škoa + MongoDB å®ç°å¢åˆ æ”¹æŸ¥

### 1.NoSQLç®€ä»‹

- ä¸å±äºå…³ç³»å‹æ•°æ®åº“çš„å“ªä¸€ç±» è¢«ç§°ä¸º NoSQL
- NoSQLæ•°æ®åº“çš„åˆ†ç±»
  - åˆ—å­˜å‚¨ï¼ˆHBaseï¼‰
  - ğŸ”¥æ–‡æ¡£å­˜å‚¨ï¼ˆMongoDBï¼‰ï¼ˆæ‰€è°“æ–‡æ¡£å­˜å‚¨å°±æ˜¯æŒ‰ç…§JSONå­˜å‚¨ï¼‰
  - key-value å­˜å‚¨ï¼ˆRedisï¼‰(é€šå¸¸ç”¨äºç¼“å­˜å’Œæ¶ˆæ¯é€šä¿¡)
  - ......
- ä¸ºä»€ä¹ˆè¦ç”¨ NoSQL
  - ç®€å•ï¼ˆæ²¡æœ‰åŸå­æ€§ï¼Œä¸€è‡´æ€§ï¼Œéš”ç¦»æ€§ç­‰å¤æ‚è§„èŒƒï¼‰ï¼ˆå…³ç³»å‹æ•°æ®åº“è¦å¤šä¸ªæœºå™¨ååŒå·¥ä½œï¼Œå¿…é¡»è¦ç¬¦åˆè¿™äº›è§„èŒƒï¼Œè¿™æ ·å°±å¢åŠ äº†å¾ˆå¤šé€šä¿¡ï¼‰
  - ä¾¿äºæ¨ªå‘æ‹“å±•ï¼ˆå› ä¸ºç®€å•ï¼Œæ²¡æœ‰è§„èŒƒï¼Œæ‰€ä»¥ä¾¿äºæ‹“å±•ï¼‰
  - é€‚åˆè¶…å¤§è§„æ¨¡çš„æ•°æ®å­˜å‚¨ï¼ˆè¿˜æ˜¯å› ä¸ºæ‹“å±•ï¼‰
  - å¾ˆçµæ´»çš„å­˜å‚¨å¤æ‚ç»“æ„çš„æ•°æ®

---

### ğŸ”¥2.mongoose è¿æ¥ MongoDB

- å®‰è£…ï¼šnpm install mongoose --save

```js
// å¼•å…¥
const mongoose = require('mongoose')

// ä½¿ç”¨
mongoose.connect('mongodb://47.95.0.108:27017/test', {useNewUrlParser: true}, () => {
    console.log('è¿æ¥æˆåŠŸ')
})
mongoose.connection.on('error', console.error);

```

---

### 3.è®¾è®¡ç”¨æˆ·æ¨¡å—çš„Schema

- è¿™é‡Œçš„Schemaæ˜¯JSONçš„ï¼Œå†™å®Œä¹‹åï¼Œæˆ‘ä»¬ç”Ÿæˆä¸€ä¸ª Model

```js
// æˆ‘ä»¬åœ¨ /app/model/users.js å»ºç«‹ä¸€ä¸ªmodelæ–‡ä»¶å¤¹ï¼Œåœ¨é‡Œé¢å»ºç«‹users.js
const mongoose = require('mongoose')
const { Schema, model } = mongoose;

const userSchema = new Schema({
    name: { type: String, required: true }, // ç¬¬ä¸€ä¸ªè¡¨ç¤ºæ˜¯å­—ç¬¦ä¸²è¿™æ²¡å•¥ï¼Œç¬¬äºŒä¸ªæ„æ€æ˜¯å¿…å†™é¡¹,å½“ç„¶è¿˜æœ‰å¾ˆå¤šè®¾ç½®ï¼Œä¾‹å¦‚ default: ** è¿™æ˜¯è®¾ç½®é»˜è®¤å€¼çš„ï¼Œå½“ç”¨æˆ·æ²¡ä¼ çš„æ—¶å€™ï¼Œè¿™ä¸ªå°±ç”Ÿæ•ˆï¼Œæ›´å¤šè¯·çœ‹ç™¾åº¦
})

module.exports = model('User', userSchema); // å‰é¢Userä¼šåœ¨MongoDBé‡Œé¢å»ºç«‹ä¸€ä¸ªé›†åˆ
```

---

### ğŸ”¥4.MongoDBå®ç°ç”¨æˆ·çš„å¢åˆ æ”¹æŸ¥

```js
// å¼•å…¥
const User = require('../model/users')

class UsersCtl {

  // æŸ¥è¯¢æ‰€æœ‰ç”¨æˆ·ï¼ˆfindé‡Œé¢ä¹Ÿèƒ½ä¼ æ­£åˆ™å“¦ï¼‰
  async findUser(ctx) {
    ctx.body = await User.find()

  }

  // æ ¹æ®IDæŸ¥è¯¢ç‰¹å®šç”¨æˆ·ï¼ˆfindByIdï¼‰
  async findById(ctx) {
    const user = await User.findById(ctx.params.id)
    if (!user) { ctx.throw(404, 'ç”¨æˆ·ä¸å­˜åœ¨')}
    ctx.body = user
  }

  // æ–°å»ºç”¨æˆ·ï¼ˆnew + save()ï¼‰
  async createUser(ctx) {
    const user = await new User(ctx.request.body).save() // è¿™é‡Œæœ‰ä¸¤ä¸ªç»†èŠ‚ï¼Œä¸€ä¸ªæ˜¯éœ€è¦ newï¼Œå¦ä¸€ä¸ªæ˜¯éœ€è¦ .save()
    ctx.body = user
  }

  // ä¿®æ”¹ï¼ˆfindByIdAndUpdateï¼‰
  async updateUser(ctx) {
    const user = await User.findByIdAndUpdate(ctx.params.id, ctx.request.body)
    if (!user) { ctx.throw(404, 'ç”¨æˆ·ä¸å­˜åœ¨')}
    ctx.body = user // æ³¨æ„ï¼šè¿™é‡Œä¿®æ”¹çš„æ˜¯è¿”å›ä¹‹å‰çš„ä¿¡æ¯
  }

  // åˆ é™¤ï¼ˆfindByIdAndRemoveï¼‰
  async deleteUser(ctx) {
    const user = await User.findByIdAndRemove(ctx.params.id)
    if (!user) { ctx.throw(404, 'ç”¨æˆ·ä¸å­˜åœ¨')}
    ctx.status = 204 // RESUful API è§„èŒƒ
  }

}

module.exports = new UsersCtl()
```


---

## ğŸ‹ç¬¬ä¸ƒç« ï¼šJWTåœ¨Koaæ¡†æ¶ä¸­å®ç°ç”¨æˆ·çš„è®¤è¯ä¸æˆæƒ

### 1.sessionç®€ä»‹

- sessionæ˜¯ä¸€ç§éå¸¸é‡è¦ï¼Œå¸¸è§çš„ï¼Œç”¨æˆ·è®¤è¯ä¸æˆæƒ

**sessionå·¥ä½œåŸç†**

- å…ˆç™»å½•ï¼Œç„¶ååç«¯è¿”å›ä¸€ä¸ªsession idï¼Œç„¶åå‰ç«¯å†è¯·æ±‚éç™»å½•çš„ä¸€äº›ä¿¡æ¯çš„æ—¶å€™éƒ½éœ€è¦å¸¦ä¸Šè¿™ä¸ªï¼Œå¦è€…æŠ¥é”™

<img src="https://itzkp-1253302184.cos.ap-beijing.myqcloud.com/notes/2.note/5.%E5%85%B6%E4%BB%96%E9%9B%B6%E6%95%A3%E7%AC%94%E8%AE%B0/%E6%85%95%E8%AF%BE%E7%BD%91%E8%AF%BE%E7%A8%8BRESTful%20API/3.png" />

- sessionçš„ä¼˜åŠ¿
  - ç›¸æ¯” JWTï¼Œæœ€å¤§çš„ä¼˜åŠ¿å°±åœ¨äºå¯ä»¥ä¸»åŠ¨æ¸…é™¤session
  - sessionä¿å­˜åœ¨æœåŠ¡å™¨ç«¯ï¼Œç›¸å¯¹è¾ƒä¸ºå®‰å…¨
  - ç»“åˆ cookie ä½¿ç”¨ï¼Œè¾ƒä¸ºçµæ´»ï¼Œå…¼å®¹æ€§è¾ƒå¥½
- sessionçš„åŠ£åŠ¿
  - cookie + session åœ¨è·¨åŸŸåœºæ™¯ä¸‹è¡¨ç°å¹¶ä¸å¥½
  - å¦‚æœæ˜¯åˆ†å¸ƒå¼éƒ¨ç½²ï¼Œéœ€è¦åšå¤šæœºå…±äº«sessionæœºåˆ¶ ğŸ”¥
  - åŸºäºcookieçš„æœºåˆ¶å¾ˆå®¹æ˜“è¢«CSRF
  - æŸ¥è¯¢ session ä¿¡æ¯å¯èƒ½ä¼šæœ‰æ•°æ®åº“æŸ¥è¯¢æ“ä½œ
- sessionç›¸å…³æ¦‚å¿µä»‹ç»
  - ä¸»è¦æ”¾åˆ°æœåŠ¡å™¨ç«¯ï¼Œç›¸å¯¹äºå®‰å…¨
  - cookie ä¸»è¦æ”¾åˆ°å®¢æˆ·ç«¯ï¼Œå¹¶ä¸æ˜¯å¾ˆå®‰å…¨
  - sessionStrongeï¼šä»…åœ¨å½“å‰ä¼šè¯ä¸‹æœ‰æ•ˆï¼Œå…³é—­é¡µé¢æˆ–è€…æµè§ˆå™¨åè¢«æ¸…é™¤
  - localstorageï¼šé™¤éè¢«æ¸…é™¤ï¼Œå¦è€…æ°¸ä¹…ä¿å­˜


---

### 2.JWTç®€ä»‹

- ä»€ä¹ˆæ˜¯JWTï¼Ÿï¼ˆJSON Web Token æ˜¯ä¸€ä¸ªå¼€æ”¾æ ‡å‡†ï¼ˆRFC 7519ï¼‰ï¼‰
- å®šä¹‰äº†ä¸€ç§ç´§å‡‘ä¸”ç‹¬ç«‹çš„æ–¹å¼ï¼Œå¯ä»¥å°†å„æ–¹ä¹‹é—´çš„ä¿¡æ¯ä½œä¸ºJSONå¯¹è±¡è¿›è¡Œå®‰å…¨ä¼ è¾“
- è¯¥ä¿¡æ¯å¯ä»¥éªŒè¯å’Œä¿¡ä»»ï¼Œå› ä¸ºæ˜¯ç»è¿‡æ•°å­—ç­¾åçš„
- JWTçš„æ„æˆï¼šå¤´éƒ¨ï¼ˆHeaderï¼‰, æœ‰æ•ˆè½½è·ï¼ˆPayloadï¼‰,ç­¾åï¼ˆSignatureï¼‰

<img src="https://itzkp-1253302184.cos.ap-beijing.myqcloud.com/notes/2.note/5.%E5%85%B6%E4%BB%96%E9%9B%B6%E6%95%A3%E7%AC%94%E8%AE%B0/%E6%85%95%E8%AF%BE%E7%BD%91%E8%AF%BE%E7%A8%8BRESTful%20API/4.png" />

**æœ‰æ•ˆè½½è·ä»‹ç»ï¼ˆè¿™ä¸ªæŒºé‡è¦çš„ï¼‰**

<img src="https://itzkp-1253302184.cos.ap-beijing.myqcloud.com/notes/2.note/5.%E5%85%B6%E4%BB%96%E9%9B%B6%E6%95%A3%E7%AC%94%E8%AE%B0/%E6%85%95%E8%AF%BE%E7%BD%91%E8%AF%BE%E7%A8%8BRESTful%20API/5.png" />


**JWTåŸç†**

<img src="https://itzkp-1253302184.cos.ap-beijing.myqcloud.com/notes/2.note/5.%E5%85%B6%E4%BB%96%E9%9B%B6%E6%95%A3%E7%AC%94%E8%AE%B0/%E6%85%95%E8%AF%BE%E7%BD%91%E8%AF%BE%E7%A8%8BRESTful%20API/6.png" />

---

### 3. JWT vs session

- å¯æ‹“å±•æ€§
  - session ä¸€èˆ¬éƒ½æ˜¯å­˜åˆ° redis è¿™ç§æ•°æ®åº“ä¸­ï¼Œä½ å¯ä»¥éœ€è¦åšä¸€ä¸ªä¸­å¿ƒå¼çš„sessionå­˜å‚¨ç³»ç»Ÿæ‰è¡Œï¼Œå¦åˆ™æ²¡åŠæ³•å…±äº«
  - åŸºäº token åŸºäº ä»¤ç‰Œçš„è¿™ç§æ–¹å¼æ˜¯æ— çŠ¶æ€çš„ï¼Œæˆ‘ä»¬å¯ä»¥è½»æ¾çš„æ‹“å±•ï¼ˆå¬ç€æ€ä¹ˆæ„Ÿè§‰è¿™ä¸ªå¾ˆæºœ ğŸ”¥ï¼‰
- å®‰å…¨æ€§ï¼ˆ...è®²äº†å››ä¸ªï¼Œæœ‰ç©ºçœ‹ä¸‹å§ï¼‰
- RESTful APIï¼ˆè¦æ±‚æ˜¯æ— çŠ¶æ€çš„ï¼Œè¿™å°±ç”¨JWTï¼‰
- æ€§èƒ½ï¼ˆå„æœ‰åˆ©å¼Šï¼‰
  - JWTå¯èƒ½æ€§èƒ½ä¸å¥½ï¼Œå› ä¸º session æ›´å°
  - session æ¯•ç«Ÿæ”¾åˆ°å®¢æˆ·ç«¯çš„æ˜¯ä¸€æ®µ idï¼Œä¼ åˆ°æœåŠ¡å™¨ç«¯ï¼ŒæœåŠ¡å™¨ç«¯è¿˜è¦æ ¹æ®è¿™ä¸ªidæ‹¿çœŸæ­£çš„ session æ•°æ®ï¼Œä¹Ÿæ˜¯æœ‰æ€§èƒ½æ¶ˆè€—çš„
- æ—¶æ•ˆæ€§
  - JWT å¿…é¡»ç­‰åˆ°è¿‡æœŸæ‰æ›´æ–°ï¼Œä¸èƒ½ä¸»åŠ¨é”€æ¯
  - session å¯ä»¥ä¸»åŠ¨é”€æ¯

---

### 4.åœ¨ Node.js ä¸­ä½¿ç”¨ JWT

- å®‰è£…ï¼šnpm i jsonwebtoken
- ç­¾åï¼š
- é€†å‘éªŒè¯ï¼š

```js
const jwt = require('jsonwebtoken');

// ç­¾åï¼ˆå‚æ•°ä¸€ï¼Œå°±æ˜¯ä¼ è¿‡æ¥çš„å‚æ•°ï¼Œå‚æ•°äºŒ æ˜¯ç§˜é’¥ï¼‰
token = jwt.sign({name: 'zhu'}, 'test')
// 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJuYW1lIjoiemh1IiwiaWF0IjoxNTYxNzI0NTUzfQ.-JVehTSs3neUbRzF__9lTsXEul_rvA5WYNbpx702Eo4'

// éªŒè¯ï¼ˆå‚æ•°ä¸€ï¼Œå‰ç«¯ä¼ è¿‡æ¥çš„tokenï¼Œå‚æ•°äºŒ ç§˜é’¥ï¼‰
jwt.verify(token, 'test')
```

---

### 5.å®ç°ç”¨æˆ·æ³¨å†Œ

- è®¾è®¡ç”¨æˆ· Schema
- ç¼–å†™ä¿è¯å”¯ä¸€æ€§çš„é€»è¾‘

```js
// è®¾è®¡ç”¨æˆ· Schema
const userSchema = new Schema({
    // è¿™ä¸ªæ˜¯è‡ªåŠ¨ç”Ÿæˆçš„ï¼Œä½†æ˜¯æ¯æ¬¡éƒ½è¿”å›ä¸å¥½ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™é‡Œç»™ä»–è®¾ç½®ä¸‹ï¼Œè®©å®ƒä¸è¿”å›
    __v: {type: Number, select: false},
    name: { type: String, required: true }, // ç¬¬ä¸€ä¸ªè¡¨ç¤ºæ˜¯å­—ç¬¦ä¸²è¿™æ²¡å•¥ï¼Œç¬¬äºŒä¸ªæ„æ€æ˜¯å¿…å†™é¡¹
    // select çš„æ„æ€æ˜¯ä¸è¿”å›ï¼Œè¿™æ˜¯å¯†ç ï¼Œå¦‚æœèƒ½è¢«è¯·æ±‚åˆ°ï¼Œé‚£æ˜¯ä¸æ˜¯å¾ˆææ€–ğŸ™€
    password: {type: String, required: true, select: false}
})

// æ–°å»ºç”¨æˆ·ï¼ˆæœ‰ä¸ªæŸ¥è¯¢ç”¨æˆ·åæ˜¯å¦é‡å¤ï¼‰
async createUser(ctx) {
  const { name } = ctx.request.body
  const repeatedUser = await User.findOne({ name }); // æŸ¥è¯¢æ˜¯å¦æœ‰è¿™ä¸ªç”¨æˆ·äº†

  if (repeatedUser) ctx.throw(409, 'ç”¨æˆ·å·²ç»å­˜åœ¨');
  const user = await new User(ctx.request.body).save()
  ctx.body = user
}
```

---

### 6.å®ç°ç™»å½•å¹¶è·å– Token

- ç™»å½•æ¥å£çš„è®¾è®¡ï¼ˆå› ä¸ºå®ƒä¸å±äºç”¨æˆ·å¢åˆ æ”¹æŸ¥ä¸­çš„ä¸€ç§ï¼‰
- ä½¿ç”¨ jsonwebtoken ç”Ÿæˆ token

```js
// ç™»å½•
async login(ctx) {
  // æ ¡éªŒç”¨æˆ·åå’Œå¯†ç 
  const user = await User.findOne(ctx.request.body)
  if (!user) { ctx.throw(401, 'ç”¨æˆ·åæˆ–è€…å¯†ç ä¸æ­£ç¡®')}
  // ç™»å½•æ­£ç¡®ï¼Œç”Ÿæˆtoken
  const { _id, name } = user;
  const token = josnwebtoken.sign({ _id, name }, key, {expiresIn: '1d'}) // å‚æ•°ä¸€ è´¦å·å¯†ç ï¼Œå‚æ•°äºŒ ç§˜é’¥ï¼Œå‚æ•°ä¸‰ é…ç½®ï¼Œè¿™é‡Œé…ç½®çš„æ˜¯è¿‡æœŸæ—¶é—´ 1d 1å¤©
  ctx.body = { token }
}
```

---

### 7.è‡ªå·±ç¼–å†™ä¸­é—´ä»¶å®ç°ç”¨æˆ·çš„è®¤è¯å’Œæˆæƒ

---

### 8.ç”¨koa-jwtä¸­é—´ä»¶å®ç°ç”¨æˆ·çš„è®¤è¯å’Œæˆæƒ

- å®‰è£…ï¼šnpm i koa-jwt --save

```js
// åœ¨è·¯ç”± /routes/users.js
const jwt = require('koa-jwt');
const auth = jwt({ secret: 'zhukunpeng'}) // ä¼ å…¥ç§˜é’¥

router.post('/user/:id', auth, checkOwner, findUserId) // æ ¹æ®ID æŸ¥è¯¢ç‰¹å®šç”¨æˆ· æ•°æ®

// /controller/users.js
// æƒé™æ ¡éªŒ
async checkOwner(ctx, next) {
  if (ctx.params.id !== ctx.state.user._id) {ctx.throw(403, 'æ²¡æœ‰æƒé™æŸ¥çœ‹')}
  await next();
}
```

<img src="https://itzkp-1253302184.cos.ap-beijing.myqcloud.com/notes/2.note/5.%E5%85%B6%E4%BB%96%E9%9B%B6%E6%95%A3%E7%AC%94%E8%AE%B0/%E6%85%95%E8%AF%BE%E7%BD%91%E8%AF%BE%E7%A8%8BRESTful%20API/7.png" />


---

## ğŸ²ç¬¬å…«ç« ï¼šä¸Šä¼ å›¾ç‰‡æ¨¡å—

### 1.ä¸Šä¼ å›¾ç‰‡éœ€æ±‚åˆ†æ

- ç”¨æˆ·å¤´åƒ
- å°é¢å›¾ç‰‡
- é—®é¢˜å’Œå›ç­”ä¸­çš„å›¾ç‰‡
- è¯é¢˜å›¾ç‰‡

---

- åŸºç¡€åŠŸèƒ½ï¼šä¸Šä¼ å›¾ç‰‡ï¼Œç”Ÿæˆå›¾ç‰‡é“¾æ¥
- é™„åŠ åŠŸèƒ½ï¼šé™åˆ¶ä¸Šä¼ å›¾ç‰‡çš„å¤§å°å’Œç±»å‹ï¼Œç”Ÿæˆé«˜ä¸­ä½ä¸‰ç§åˆ†è¾¨ç‡çš„å›¾ç‰‡é“¾æ¥ï¼Œç”ŸæˆCDN
- ä¸Šä¼ å›¾ç‰‡çš„æŠ€æœ¯æ–¹æ¡ˆ
  - é˜¿é‡Œäº‘OSSç­‰äº‘æœåŠ¡ï¼Œæ¨èç”Ÿæˆç¯å¢ƒä¸‹ä½¿ç”¨
  - ç›´æ¥ä¸Šä¼ åˆ°æœåŠ¡å™¨ï¼Œä¸æ¨èåœ¨ç”Ÿäº§ç¯å¢ƒä¸‹ä½¿ç”¨ï¼Œå› ä¸ºä¸ç¨³å®š

---

### 2.ä½¿ç”¨ koa-body ä¸­é—´ä»¶è·å–ä¸Šä¼ çš„æ–‡ä»¶

- ä¹‹å‰æˆ‘ä»¬ç”¨çš„æ˜¯ koa-bodyparser ï¼Œä½†æ˜¯è¿™ä¸ªä¸æ”¯æŒæ–‡ä»¶ï¼Œåªæ”¯æŒ JSON å’Œ... ï¼Œæ‰€ä»¥æˆ‘ä»¬ç”¨ koa-body è¿™ä¸ªä¸­é—´ä»¶
- å®‰è£…ï¼šnpm i koa-body  --save

```js
// app.js && å»ºç«‹ public/uploads ç”¨æ¥ç››æ”¾ä¸Šä¼ æ–‡ä»¶
const bodyBody = require('koa-body')
app.use(bodyBody({
    multipart: true, // å¯ç”¨æ–‡ä»¶ä¼ è¾“
    formidable: {
        uploadDir: path.join(__dirname, 'app/public/uploads'), // æ–‡ä»¶ä¸Šä¼ è·¯å¾„
        keepExtensions: true, // ä¿ç•™æ‹“å±•å
    }
})) // è§£æ è¯·æ±‚bodyä¸­çš„ JSON

// å»ºç«‹ controller/home.js
class HomeCtl {

    // ä¸Šä¼ æ–‡ä»¶
    upload(ctx) {
        const file = ctx.request.files;
        ctx.body = {
          message: 'ä¸Šä¼ æˆåŠŸ'
        } 
    }
}

module.exports = new HomeCtl()

// å»ºç«‹ router/home.js
const Router = require('koa-router');
const router = new Router; // new Router({prefix:'user'}) è¿™æ ·å¯ä»¥è®¾ç½®è·¯ç”±å‰ç¼€ï¼Œä¹Ÿæ˜¯å®ç”¨çš„
const { upload } = require('../controller/home');

router.post('/upload', upload)

module.exports = router

```

---

### 3.ä½¿ç”¨ koa-static ä¸­é—´ä»¶ç”Ÿæˆå›¾ç‰‡é“¾æ¥

- å®‰è£…ï¼šnpm i koa-static --save

```js
// app.js
const koaStatic = require('koa-static')
app.use(koaStatic(path.join(__dirname, 'app/public/'))) // ç”Ÿæˆä¸Šä¼ å›¾ç‰‡é“¾æ¥ï¼Œè¿™é‡Œè¿˜å¯åŠ¨äº†é™æ€æœåŠ¡ï¼Œç›´æ¥ä»£ç†æˆ‘ä»¬è®¾ç½®çš„æ–‡ä»¶è·¯å¾„


// controller/home.js
const path = require('path')
class HomeCtl {
    // ä¸Šä¼ æ–‡ä»¶
    upload(ctx) {
        const file = ctx.request.files.file;
        const basename = path.basename(file.path)
        ctx.body = { url: `${ctx.origin}/uploads/${basename}`}
    }
}
module.exports = new HomeCtl()

```

---

### 4.ç¼–å†™å‰ç«¯é¡µé¢ä¸Šä¼ æ–‡ä»¶

```html
<form action="http://localhost:3000/upload" enctype="multipart/form-data" method="POST">
  <input type="file" name="file">
  <button type="submit">ä¸Šä¼ </button>
</form>
```

**è¿”å›ç»“æœ**

```js
{
    "url": "http://localhost:3000/uploads/upload_34ca030139713427223a1c8b604b603a.jpg"
}
```

---

## ğŸ€ç¬¬ä¹ç« ï¼šä¸ªäººèµ„æ–™æ¨¡å—

---

### 1.ä¸ªäººèµ„æ–™çš„ schema è®¾è®¡

```js
// module/users.js
const mongoose = require('mongoose');
const { Schema, model } = mongoose;

const userSchema = new Schema({
    __v: {type: Number, select: false},
    name: { type: String, required: true }, // ç¬¬ä¸€ä¸ªè¡¨ç¤ºæ˜¯å­—ç¬¦ä¸²è¿™æ²¡å•¥ï¼Œç¬¬äºŒä¸ªæ„æ€æ˜¯å¿…å†™é¡¹
    password: {type: String, required: true, select: false},
    avatar_url: { type: String }, // å¤´åƒçš„URL
    gender: { type: String, enum: ['male', 'famale'], default: 'male' }, // æ€§åˆ«ï¼Œè¿™é‡Œåé¢ enum æ˜¯mongooseçš„å¯æšä¸¾ç±»å‹ï¼Œæšä¸¾çš„å€¼æ˜¯é‚£ä¸¤ä¸ª, åé¢çš„æ˜¯é»˜è®¤å€¼ male
    handline: { type: String }, // ä¸€å¥è¯ä»‹ç»
    loacations: { type: [{type: String}]}, // å±…ä½åœ°ï¼Œç±»å‹æ˜¯å­—ç¬¦ä¸²æ•°ç»„
    employments: { // èŒä¸šç»å†
        type: {
            company: { type: String }, // å…¬å¸
            job: { type: String } // èŒä½
        }
    }
})

module.exports = model('User', userSchema); // å‰é¢Userä¼šåœ¨MongoDBé‡Œé¢å»ºç«‹ä¸€ä¸ªé›†åˆ

```

---

### 2.ä¸ªäººèµ„æ–™çš„å‚æ•°æ ¡éªŒ

```js
// è¿˜æ˜¯æœ‰ä¸€äº›å’Œ mongoose ä¸ä¸€æ ·çš„åœ°æ–¹ï¼Œè¿™é‡Œè¦æ³¨æ„
ctx.verifyParams({
  name: { type: 'string' },
  avatar_url: { type: 'string', required: false }, // required: falseè¡¨ç¤ºéå¿…é€‰
  gender: { type: 'string', required: false },
  handline: { type: 'string', required: false },
  loacations: { type: 'array', itemType: 'string', required: false }, // itemTypeè¿™æ˜¯è¡¨ç¤ºæ•°ç»„é‡Œé¢çš„é¡¹æ˜¯å­—ç¬¦ä¸²ç±»å‹ï¼Œè¿™å’Œmongooseä¸ä¸€æ ·
  employments: { type:'array', itemType: 'object', required: false }
})
```

---

### ğŸ”¥3.RESTful API æœ€ä½³å®è·µ - å­—æ®µè¿‡æ»¤

- æœ‰å“ªäº›å­—æ®µæ˜¾ç¤ºï¼Œå“ªäº›å­—æ®µä¸æ˜¾ç¤ºï¼Œæœ‰ç§GrhpQLçš„æ„Ÿè§‰

```js
// é€šè¿‡ select: false æˆ‘ä»¬å¯ä»¥éšè—ä¸€äº›è¿”å›å­—æ®µ
const userSchema = new Schema({
    __v: {type: Number, select: false},
    name: { type: String, required: true }, // ç¬¬ä¸€ä¸ªè¡¨ç¤ºæ˜¯å­—ç¬¦ä¸²è¿™æ²¡å•¥ï¼Œç¬¬äºŒä¸ªæ„æ€æ˜¯å¿…å†™é¡¹
    password: {type: String, required: true, select: false},
    avatar_url: { type: String }, // å¤´åƒçš„URL
    gender: { type: String, enum: ['male', 'famale'], default: 'male' }, // æ€§åˆ«ï¼Œè¿™é‡Œåé¢ enum æ˜¯mongooseçš„å¯æšä¸¾ç±»å‹ï¼Œæšä¸¾çš„å€¼æ˜¯é‚£ä¸¤ä¸ª, åé¢çš„æ˜¯é»˜è®¤å€¼ male
    handline: { type: String, select: false}, // ä¸€å¥è¯ä»‹ç»
    loacations: { type: [{type: String}], select: false}, // å±…ä½åœ°ï¼Œç±»å‹æ˜¯å­—ç¬¦ä¸²æ•°ç»„
    employments: { // èŒä¸šç»å†
        type: {
            company: { type: String }, // å…¬å¸
            job: { type: String } // èŒä½
        },
        select: false
    }
})

// /controller/users.jsï¼ˆä¸»è¦å°±æ˜¯å€ŸåŠ©mongoose çš„ selectæ–¹æ³•ï¼Œæ‹¼æ¥æˆ +...+...è¿™ç§å½¢å¼ï¼‰

// é—®é¢˜å°±æ˜¯ ç°åœ¨ä¸€ä¸ªå¯ä»¥ï¼Œä½†æ˜¯ä¸¤ä¸ªå°±ä¸è¡Œäº†

// æŸ¥è¯¢ç”¨æˆ·
async findUser(ctx) {
  const { fields } = ctx.query; // è¿™æ˜¯ä»¥åˆ†å·éš”å¼€çš„
  let selectFidlds = null;
  // å°†åˆ†å·éš”å¼€çš„è½¬ä¸º +...+ è¿™ç§å½¢å¼
  if (fields) selectFidlds = fields.split(';').filter(f => f).map(f => '+' + f).join('');
  ctx.body = await User.find().select(`${selectFidlds}`)
}
```

---

## ğŸŒ³ç¬¬åç« ï¼šå…³æ³¨ä¸ç²‰ä¸æ¨¡å—

### 1.å…³æ³¨ä¸ç²‰ä¸çš„ schema è®¾è®¡

**åŠŸèƒ½ç‚¹**

- å…³æ³¨ï¼Œå–æ¶ˆå…³æ³¨
- è·å–å…³æ³¨äººï¼Œç²‰ä¸åˆ—è¡¨ï¼ˆç”¨æˆ·-ç”¨æˆ· å¤šå¯¹å¤šå…³ç³»ï¼‰

---

```js
const userSchema = new Schema({
  // ......
  following: { // å…³æ³¨
      type: [ { type: Schema.Types.ObjectId, ref: 'User' } ], // éå¸¸å¥½çš„ä¸€ä¸ªæŠ€å·§ï¼Œä½†æ˜¯æˆ‘ä¸å¤ªæ‡‚
      select: false
  }
})

```


---

### 2.RESTful API é£æ ¼çš„å…³æ³¨ä¸ç²‰ä¸æ¥å£

```js
// controller/users.js
// è·å–ç”¨æˆ·çš„å…³æ³¨è€…
async listFollowing(ctx) {
  const user = await User.findById(ctx.params.id).select('+following').populate('+following')
  // è·å–çš„å…³æ³¨è€…æ˜¯ç”¨æˆ·çš„IDï¼Œæˆ‘ä»¬æ­£å¸¸æ¥è¯´éœ€è¦éå†è¿™ä¸ªIDï¼Œæ‰èƒ½æ‹¿åˆ°æ¯ä¸ªå…³æ³¨è€…çš„å¤´åƒå’Œå…¶ä»–ä¿¡æ¯
  // ä½†æ˜¯ model/users.js é‡Œé¢çš„ç»“æ„é‚£ä¹ˆå†™ï¼Œè®©æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ populate() è¿™ä¸ªå¿«æ·æ–¹æ³•äº†
  if (!user) {ctx.throw(404, 'ç”¨æˆ·ä¸å­˜åœ¨')}
  ctx.body = user.following
}
// ç”¨æˆ·-å…³æ³¨ç”¨æˆ·
async follow(ctx) {
  const me = await User.findById(ctx.state.user._id).select('+following')
  if (!me.following.map(id => id.toString()).includes(ctx.params.id)) {
    me.following.push(ctx.params.id) // æŠŠæ•°ç»„æ”¾åˆ°çš„IDæ”¾åˆ°é‡Œé¢
    me.save()
  }
  ctx.status = 204
}
// ç”¨æˆ·-å–æ¶ˆå…³æ³¨
async unfollow(ctx) {
  const me = await User.findById(ctx.state.user._id).select('+following')
  const index = me.following.map(id => id.toString()).indexOf(ctx.params.id)
  if (index > -1) {
    me.following.splice(index, 1)
    me.save()
  }
  ctx.status = 204
}
// ç”¨æˆ·-è·å–ç²‰ä¸
async listFollowers(ctx) {
  const users = await User.find({following: ctx.params.id})
  ctx.body = users
}


// routes/users.js
router.get('/user/:id/following', listFollowing) // è·å–æŸä¸ªç”¨æˆ· å…³æ³¨äº†è°
router.get('/user/:id/followers', listFollowers) // è·å–æŸä¸ªç”¨æˆ· å…³æ³¨äº†è°
router.put('/user/following/:id', auth, follow) // ç”¨æˆ·-å…³æ³¨ç”¨æˆ·
router.delete('/user/following/:id', auth, unfollow) // ç”¨æˆ·-å–æ¶ˆå…³æ³¨
```

---

### 3.ç¼–å†™æ ¡éªŒç”¨æˆ·å­˜åœ¨ä¸å¦çš„ä¸­é—´ä»¶

**åœ¨å…³æ³¨ï¼Œå’Œå–æ¶ˆå…³æ³¨ä¹‹å‰ï¼Œæ ¡éªŒä¸€ä¸‹ç”¨æˆ·å­˜åœ¨ä¸å¦**

```js
// controller/users.js
// æ£€æµ‹ç”¨æˆ·æ˜¯å¦å­˜åœ¨ï¼ˆä¸­é—´ä»¶ï¼‰
async checkUserExist(ctx, next) {
  const user = await User.findById(ctx.params.id)
  if (!user) { ctx.throw(404, 'ç”¨æˆ·ä¸å­˜åœ¨')}
  await next()
}

// routes/users.jsï¼ˆæ·»åŠ ï¼‰
router.put('/user/following/:id', auth, checkUserExist, follow) // ç”¨æˆ·-å…³æ³¨ç”¨æˆ·
router.delete('/user/following/:id', auth, checkUserExist, unfollow) // ç”¨æˆ·-å–æ¶ˆå…³æ³¨
```

---

## ğŸŒ´ç¬¬åä¸€ç« ï¼šè¯é¢˜æ¨¡å—

### 1.è¯é¢˜å¢æ”¹æŸ¥æ¥å£

**åŠŸèƒ½æ¨¡å—åŠŸèƒ½ç‚¹**

- è¯é¢˜çš„å¢æ”¹æŸ¥ï¼ˆæ²¡æœ‰åˆ ï¼Œå› ä¸ºè¯é¢˜å…³è”å¤ªå¤šï¼‰
- åˆ†é¡µï¼Œæ¨¡ç³ŠæŸ¥è¯¢
- ç”¨æˆ·å±æ€§ä¸­çš„è¯é¢˜å¼•ç”¨
- å…³æ³¨/å–æ¶ˆå…³æ³¨è¯é¢˜ï¼Œç”¨æˆ·å…³æ³¨çš„è¯é¢˜åˆ—è¡¨

**è®¾è®¡Schema**

```js
// å»ºç«‹æ–°æ–‡ä»¶ modle/topics.js
const mongoose = require('mongoose');
const { Schema, model } = mongoose;

const topicSchema = new Schema({
    __v: {type: Number, select: false},
    name: { type: String, required: true }, // è¯é¢˜åç§°
    avatar_url: { type: String }, // è¯é¢˜å›¾ç‰‡
    introduction: { type: String, select: false}, // è¯é¢˜ç®€ä»‹
})

module.exports = model('Topic', topicSchema);
```

**å†™Controller**

```js
// å»ºç«‹æ–°æ–‡ä»¶ controller/topics.js
const Topic = require('../model/topics')

class TopicsCtl {
   
    // è·å–è¯é¢˜åˆ—è¡¨
    async find(ctx) {
        ctx.body = await Topic.find();
    }

    // æŸ¥è¯¢ç‰¹å®šè¯é¢˜
    async findById(ctx) {
        // const { fields } = ctx.query
        // const selectFields = fields.split(';').filter(f => f).map(f => ' +' + f).join('')
        // const topic = await Topic.findById(ctx.params.id).select(selectFields)
        const topic = await Topic.findById(ctx.params.id)
        ctx.body = topic
    }

    // åˆ›å»ºè¯é¢˜
    async create(ctx) {
        ctx.verifyParams({
            name: { type: 'string', required: true },
            avatar_url: { type: 'string', required: false },
            introduction: { type: 'string', required: false }
        })

        const topic = await new Topic(ctx.request.body).save()
        ctx.body = topic
    }

    // ä¿®æ”¹è¯é¢˜
    async update(ctx) {
        ctx.verifyParams({
            name: { type: 'string', required: false },
            avatar_url: { type: 'string', required: false },
            introduction: { type: 'string', required: false }
        })

        const topic = await Topic.findByIdAndUpdate(ctx.params.id, ctx.request.body)
        ctx.body = topic
    }
}

module.exports = new TopicsCtl()
```

**å†™Routes**

```js
// å»ºç«‹æ–‡ä»¶ routes/topics.js
const Router = require('koa-router');
const router = new Router; // new Router({prefix:'user'}) è¿™æ ·å¯ä»¥è®¾ç½®è·¯ç”±å‰ç¼€ï¼Œä¹Ÿæ˜¯å®ç”¨çš„
const { find, findById, create, update } = require('../controller/topics');
const jwt = require('koa-jwt');
const auth = jwt({ secret: 'zhukunpeng'}) // ä¼ å…¥ç§˜é’¥

router.get('/topics', find) // æŸ¥è¯¢æ‰€æœ‰è¯é¢˜
router.post('/topics', auth, create) // åˆ›å»ºè¯é¢˜
router.get('/topics/:id', findById) // è·å–ç‰¹å®šè¯é¢˜
router.patch('/topics/:id', auth, update) // ä¿®æ”¹ç‰¹å®šè¯é¢˜

module.exports = router
```

---

### ğŸ”¥2.åˆ†é¡µå®ç°

**æ ¹æ®æŸ¥è¯¢å­—ç¬¦ä¸²æ¥é™åˆ¶åˆ—è¡¨çš„è¿”å›å€¼**

```js
// è·å–è¯é¢˜åˆ—è¡¨ çš„åˆ†é¡µé€»è¾‘ï¼ˆä¸»è¦æ˜¯ç®—æ³•ï¼‰
async find(ctx) {
    const { per_page = 10 } = ctx.query
    const page = Math.max(ctx.query.page * 1, 1) - 1 // å½“å‰æ˜¯ç¬¬å‡ é¡µ
    const perPage = Math.max(per_page * 1, 1) // æ¯é¡µæ˜¾ç¤ºå‡ æ¡
    // mongoose limit() å¯ä»¥è·å–å‡ ä¸ªï¼Œskip() å¯ä»¥ä»ç¬¬å‡ ä¸ªå¼€å§‹ï¼Œè™½ç„¶æ²¡æœ‰ limit(x, y) è¿™ç§å¥½ï¼Œä½†æ˜¯ä¹Ÿè¡Œ
    ctx.body = await Topic.find().limit(perPage).skip(page * perPage);
}

// ç¤ºä¾‹ï¼šhttp://localhost:3000/topics?page=1&per_page=2
```

---

### ğŸ”¥3.æ¨¡ç³Šæœç´¢ï¼ˆå…³é”®è¯æœç´¢ï¼‰

**å€ŸåŠ©mongooseè¯­æ³•ç³–ï¼Œä¸€è¡Œä»£ç å°±èƒ½å®ç°ï¼šåœ¨find() é‡Œé¢å†™æ­£åˆ™**

```js
// ......
ctx.body = await Topic
    .find({ name: new RegExp(ctx.query.q) })
    .limit(perPage).skip(page * perPage);

// mongooseä½¿ç”¨å¤šä¸ªå­—æ®µçš„æ¨¡ç³Š
// .find({ $or: [{name: ...}, {...}] })
```

---

### â£ï¸4.ç”¨æˆ·å±æ€§ä¸­çš„è¯é¢˜å¼•ç”¨

**æ²¡å¤ªæ‡‚ï¼Œä½†æ˜¯è¿™é‡Œ type: Schema.Types.ObjectId, ref: 'Topic' æ–¹æ³•æ˜¯ä¸€ç§å¼•ç”¨ï¼Œç±»ä¼¼äºMySQLçš„å¤–é“¾ï¼Œå¤šè¡¨æŸ¥è¯¢ç”¨çš„é‚£ç§**

---

### 5.å…³æ³¨è¯é¢˜æ¥å£ï¼ˆç•¥...ï¼‰

---

## ğŸŒ±ç¬¬åäºŒç« ï¼šé—®é¢˜æ¨¡å—

### 1.é—®é¢˜çš„å¢åˆ æ”¹æŸ¥ï¼Œç”¨æˆ·çš„é—®é¢˜åˆ—è¡¨ï¼ˆç”¨æˆ·-é—®é¢˜ ä¸€å¯¹å¤šå…³ç³»ï¼‰

ä¸€ä¸ªç”¨æˆ·å¯ä»¥æå¤šä¸ªé—®é¢˜ï¼Œä½†æ˜¯ä¸€ä¸ªé—®é¢˜åªå±äºä¸€ä¸ªç”¨æˆ·

**å»ºç«‹ Schema**

```js
const mongoose = require('mongoose');
const { Schema, model } = mongoose;

const questionSchema = new Schema({
    __v: {type: Number, select: false},
    title: { type: String, required: true }, // é—®é¢˜æ ‡é¢˜
    description: { type: String }, // æè¿°
    questioner: { type: Schema.Types.ObjectId, ref: 'User', required: true, select: false}, // æé—®è€…ï¼Œè¿™ä¸ªè®¾è®¡æ˜¯å®ç° ä¸€å¯¹å¤šçš„æ ¸å¿ƒ
})

module.exports = model('Question', questionSchema);
```

**å®ç° Controller**

```js

```

**â£ï¸è¿™é‡Œæˆ‘çªç„¶æœ‰ä¸€ä¸ªæƒ³æ³•ï¼Œå°±æ˜¯ å¯ä»¥æŠ½è±¡å‡ºä¸€ä¸ªåŸºæœ¬ç±»ï¼Œä¸Šé¢æŒ‚è½½åˆ†é¡µæ–¹æ³•ï¼Œæ¨¡ç³ŠæŸ¥è¯¢æ–¹æ³•ç­‰ï¼Œç”šè‡³å¢åˆ æ”¹æŸ¥æ¥å£ä¹Ÿèƒ½æŠ½ç¦»æˆå…¬å…±çš„ï¼Œä¸‹é¢çš„ç±»è°æƒ³ç”¨äº†ï¼Œå°±ç›´æ¥ç”¨ç»§æ‰¿ï¼Œç„¶åä½¿ç”¨äº†**

---

### 2.è¯é¢˜-é—®é¢˜ å¤šå¯¹å¤šå…³ç³»

- æ€è·¯ï¼šä¸¤ä¸ªåˆ—è¡¨ï¼Œå°±æ˜¯è¿™ä¸¤ä¸ªåˆ—è¡¨éƒ½èƒ½æˆä¸ºå¯¹æ–¹çš„åˆ—è¡¨

---

## ğŸŒ¿ç¬¬åä¸‰ç« ï¼šç­”æ¡ˆæ¨¡å—

### 1.ç­”æ¡ˆæ¨¡å—äºŒçº§åµŒå¥—çš„å¢åˆ æ”¹æŸ¥æ¥å£


---

## ğŸŒ¾ç¬¬åå››ç« ï¼šè¯„è®ºæ¨¡å—

---

## ğŸŒ¿ç¬¬åäº”ç« ï¼šé¡¹ç›®ä¸Šçº¿ï¼Œéƒ¨ç½²


### 1.ç”¨NGINXå®ç°ç«¯å£è½¬å‘

**ä¸€èˆ¬æœåŠ¡å™¨å¾ˆå¤šç«¯å£éƒ½æ²¡å¼€ï¼Œä¸€èˆ¬80ç«¯å£å¼€äº†ï¼ŒNGINX å°±å¯ä»¥ä»£ç†80ç«¯å£ï¼Œç„¶åè®¿é—®åˆ°å†…ç½‘çš„å…·ä½“ç«¯å£ä¸Š**

- è¯­æ³•æ£€æŸ¥ï¼šnginx -tï¼ˆä¸»è¦ä¿®æ”¹nginx.confï¼‰
- é‡å¯ï¼šservice nginx restart

<img src="https://itzkp-1253302184.cos.ap-beijing.myqcloud.com/notes/2.note/5.%E5%85%B6%E4%BB%96%E9%9B%B6%E6%95%A3%E7%AC%94%E8%AE%B0/%E6%85%95%E8%AF%BE%E7%BD%91%E8%AF%BE%E7%A8%8BRESTful%20API/8.png" />

**Postmanç”Ÿæˆæ–‡æ¡£**

- è¿˜æ˜¯å¾ˆæ¼‚äº®çš„

<img src="https://itzkp-1253302184.cos.ap-beijing.myqcloud.com/notes/2.note/5.%E5%85%B6%E4%BB%96%E9%9B%B6%E6%95%A3%E7%AC%94%E8%AE%B0/%E6%85%95%E8%AF%BE%E7%BD%91%E8%AF%BE%E7%A8%8BRESTful%20API/9.png" />

---

## ğŸ“šå‚è€ƒåˆ—è¡¨ï¼ˆæœ€åæ›´æ–°2019.6.23 23:23ï¼‰

- [æ…•è¯¾ç½‘è¯¾ç¨‹-Node.jså¼€å‘ä»¿çŸ¥ä¹æœåŠ¡ç«¯ æ·±å…¥ç†è§£RESTful API](https://coding.imooc.com/learn/list/354.html)