# 2.åŸç”ŸNode

::: warning
ç­‰å¾…ä¹¦å†™ä¸­...
:::

## åŸºç¡€æ¦‚å¿µ

### å…¨å±€å˜é‡

> è¿™äº”ä¸ªä¸æ˜¯å…¨å±€çš„ï¼Œä½†æ˜¯å¯ä»¥ç›´æ¥è®¿é—®

- require 
- exports
- module
- __dirname
- __filename

---

### process

---

### env/argv

---

### cwd()

---

### nextTick()


---

### Nodeäº‹ä»¶ç¯

> Nodeæ˜¯åŸºäºv8å¼•æ“çš„ï¼Œä½†æ˜¯ä¸€äº›å†™æ³•ä¸æ˜¯Nodeæä¾›çš„ï¼Œä¾‹å¦‚ fs.rendFile() , è¿™äº›æ˜¯ç”± libuvåº“æä¾›ï¼Œè¿™ä¸ªåº“è¿˜æä¾› éé˜»å¡i/0æ“ä½œ

Nodeä¸­ä¹Ÿæœ‰è‡ªå·±çš„äº‹ä»¶ç¯ï¼Œä» node10.xä¹‹åéƒ½å’Œæµè§ˆå™¨çš„æ‰§è¡Œé¡ºåºä¸€è‡´
 
- 10.x åï¼Œæ‰§è¡Œå®Œæˆä¸€ä¸ªå®ä»»åŠ¡ï¼Œå°±æ‰§è¡Œå¾®ä»»åŠ¡ï¼ˆå’Œæµè§ˆå™¨ä¸€è‡´ï¼‰
- 10.x å‰ï¼Œæ˜¯å®ä»»åŠ¡éƒ½æ‰§è¡Œå®Œæˆï¼Œæ‰ä¼šæ¸…ç©ºé˜Ÿåˆ—ï¼Œæ‰§è¡Œå¾®ä»»åŠ¡


```
               å®ä»»åŠ¡
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”Œâ”€>â”‚           timers          â”‚ ğŸ”¥å®šæ—¶å™¨
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”‚     pending callbacks     â”‚ ä¸Šä¸€è½®æ²¡æ‰§è¡Œå®Œæˆçš„ï¼Œå›è°ƒå‡½æ•°
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”‚       idle, prepare       â”‚ å†…éƒ¨ç³»ç»Ÿä½¿ç”¨çš„é˜Ÿåˆ—
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚   incoming:   â”‚
â”‚  â”‚           poll            â”‚<â”€â”€â”€â”€â”€â”¤  connections, â”‚ ğŸ”¥è½®è¯¢ï¼ˆæ‰§è¡Œi/0å›è°ƒï¼‰
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚   data, etc.  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â”‚           check           â”‚  ğŸ”¥setImmediateï¼ˆå½“å‰ä¸€è½®è½®è¯¢ç»“æŸåï¼Œæ‰§è¡Œï¼‰
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â””â”€â”€â”¤      close callbacks      â”‚ å…³é—­çš„å›è°ƒï¼ˆä¾‹å¦‚ websocketå…³é—­ï¼‰
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚          nextTick         â”‚ ğŸ”¥ä¸Šé¢é˜Ÿåˆ—éƒ½æ‰§è¡Œå®Œæˆï¼Œä¼šç«‹å³æ‰§è¡Œè¿™é‡Œï¼Œç„¶åå†è¿›è¡Œæ–°ä¸€è½®çš„å¾ªç¯ï¼ˆå¾®ä»»åŠ¡ï¼‰
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚         å¾®ä»»åŠ¡é˜Ÿåˆ—          â”‚ ğŸ”¥æ¸…ç©ºå¾®ä»»åŠ¡é˜Ÿåˆ—ï¼Œä¹‹åå†æ‰§è¡Œä¸Šé¢çš„Nodeäº‹ä»¶ç¯ï¼ˆéƒ½æ˜¯å®ä»»åŠ¡ï¼‰
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

```js
setTimeout(() => {
  console.log('timeout')
}, 0)

Promise.resolve().then(() => {
  console.log('promise')
})

// ğŸ”¥ å½“å‰æ‰§è¡Œæ ˆä¸­æ‰§è¡Œå®Œæ¯•ï¼Œç«‹å³è°ƒç”¨ï¼Œä¹‹åå†è°ƒç”¨å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼ˆnextTickä¹Ÿæ˜¯å¾®ä»»åŠ¡ï¼‰
process.nextTick(() => {
  console.log('nextTick')
})

// nextTick
// promise
// timeout

// =================================================================

setTimeout(() => {
  console.log('timeout')
}, 0)

setImmediate(() => {
  console.log('setImmediate')
})

// è¿™ä¸ªæ‰§è¡Œé¡ºåºä¸ç¡®å®šï¼Œæ ¹æ®ç”µè„‘æ€§èƒ½æœ‰å…³
// ğŸ”¥ åŸå› æ˜¯ pollé˜Ÿåˆ— ï¼Œä¼šç­‰ä¸€ä¼šï¼Œå¦‚æœè¿™æ—¶å€™å®šæ—¶å™¨åˆ°äº†ï¼Œå°±ä¼šå›å»æ‰§è¡Œå®šæ—¶å™¨

// =================================================================

// ğŸ”¥ è¿™ä¸ªæƒ…å†µå°±æ˜¯å”¯ä¸€çš„äº†ï¼Œå› ä¸º poll æ‰§è¡Œå®Œæˆäº†ï¼Œæ‰€ä»¥è‚¯å®šä¼šèµ° check é˜Ÿåˆ—

// setImmediate
// timeout

fs.readFile('xxx.txt', () => {

  setTimeout(() => {
    console.log('timeout')
  }, 0)

  setImmediate(() => {
    console.log('setImmediate')
  })

})
```

æ‹“å±•è¡¥å……

- poll æœ‰æœ€å¤§æ‰§è¡Œä¸ªæ•°ï¼Œè¶…è¿‡è¿™ä¸ªæ•°é‡å°±ä¼šè¢«å»¶è¿Ÿåˆ°ä¸‹ä¸€è½®å¾ªç¯æ‰§è¡Œ
- nodeä¸­çš„å¾®ä»»åŠ¡ï¼šPromise.then / nextTickï¼Œæ²¡æœ‰ mutationObserver

---

## æ¨¡å—æ¦‚å¿µ

### commonjsè§„èŒƒ

> Nodeä¸­ä½¿ç”¨çš„è§„èŒƒï¼Œä¸æ”¯æŒ esm è§„èŒƒï¼ˆä½†æ˜¯å¯ä»¥é€šè¿‡babelç¼–è¯‘æ‰§è¡Œï¼‰

æ ¸å¿ƒæ€æƒ³ï¼š

- æ¯ä¸€ä¸ªæ–‡ä»¶éƒ½æ˜¯ä¸€ä¸ªæ¨¡å—
- éœ€è¦é€šè¿‡ module.exports å¯¼å‡º
- å¯¼å…¥éœ€è¦çš„æ¨¡å—

Nodeä¸­åˆ’åˆ†äº†å‡ ç±»æ¨¡å—çš„ä½¿ç”¨

- å†…ç½®æ¨¡å—ï¼ˆä¾‹å¦‚fsï¼‰ï¼š
- è‡ªå®šä¹‰æ¨¡å—ï¼šrequire()
- ç¬¬ä¸‰æ–¹æ¨¡å—ï¼š

---

### esmè§„èŒƒ

---

### umdæ¨¡å—

---

### amdæ¨¡å—

---

## æ ¸å¿ƒæ¨¡å—

- fs
- path
- vm


### å®ç°ä¸€ä¸ªCommonJs

> å‰ç½®çŸ¥è¯†

```js
const fs = require('fs')
const path = require('path')
const vm = require('vm') // è™šæ‹Ÿæœºæ¨¡å—

// ================================================

// 

// ================================================

// ç»™æˆ‘ä¸€ä¸ªç›¸å¯¹è·¯å¾„ï¼Œè¿”å›ä¸€ä¸ªç»å¯¹è·¯å¾„ï¼ˆ__dirname å½“å‰æ–‡ä»¶æ‰€åœ¨ç›®å½•ï¼‰
path.resolve(__dirname, 'index.js', '/')
path.join(__dirname, 'index.js', '/')

// åŒºåˆ«ï¼špath.resolve å°† / è¯†åˆ«æˆæ ¹è·¯å¾„ï¼Œpath.join å°±æ˜¯ç®€å•çš„æ‹¼æ¥ï¼Œä¸€èˆ¬ä½¿ç”¨ path.join è¿›è¡Œæ‹¼æ¥

// ================================================

const a = 100;
const log = `console.log(a)`

// ç›´æ¥æ‰§è¡Œå­—ç¬¦ä¸²ï¼Œå¹¶ä¸”åœ¨æ²™ç®±ç¯å¢ƒä¸­ a is defind
// å‰ç«¯æ²¡æœ‰è¿™ä¸ªæ–¹æ³•ï¼Œæ‰€ä»¥ä¸€èˆ¬éƒ½ç”¨ new Function +  with
vm.runInContext(log)
```

```js
const fs = require('fs');
const path = require('path');
const vm = require('vm');

function Module(id) {
    this.id = id;
    this.exports = {}; 
}
Module.wrapper = [
    `(function(exports,require,module,__filename,__dirname){`,
    `})`
];
Module._extensions = {
    '.js'(module) {
        let content = fs.readFileSync(module.id, 'utf8');
        content = Module.wrapper[0] + content + Module.wrapper[1];
        let fn = vm.runInThisContext(content);
        let exports = module.exports;
        let dirname = path.dirname(module.id);
        fn.call(exports, exports, req, module, module.id, dirname);
    },
    '.json'(module) {
        let content = fs.readFileSync(module.id, 'utf8');
        module.exports = JSON.parse(content);
    }
}
Module._resolveFilename = function (filename) {
    let absPath = path.resolve(__dirname, filename);
    let isExists = fs.existsSync(absPath);
    if (isExists) {
        return absPath;
    } else {
        let keys = Object.keys(Module._extensions);
        for (let i = 0; i < keys.length; i++) {
            let newPath = absPath + keys[i];
            let flag = fs.existsSync(newPath);
            if (flag) {
                return newPath;
            }
        }
        throw new Error('module not exists');
    }
}
Module.prototype.load = function () {
    let extName = path.extname(this.id);
    Module._extensions[extName](this);
}
Module._cache = {};

function req(filename) {
    filename = Module._resolveFilename(filename);
    let cacheModule = Module._cache[filename];
    if (cacheModule) {
        return cacheModule.exports; 
    }
    let module = new Module(filename);
    Module._cache[filename] = module
    module.load();
    return module.exports;
}
```

---

## æ–‡ä»¶è¯»å†™æµ

